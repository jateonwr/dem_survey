<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>แบบฟอร์มสำรวจข้อมูล DEM ของหน่วยงานรัฐในประเทศไทย</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      body {
        font-family: "Sarabun", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }
      select[multiple] {
        min-height: 3.5rem;
      }

/* toggle-pill (ปรับขนาดให้เล็กลง) */
      .toggle-pill {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 54px; /* ลดความกว้าง */
        height: 22px;    /* ลดความสูง */
        border-radius: 9999px;
        cursor: pointer;
        border: none;
        outline: none;
        transition: background-color 0.25s ease;
        padding: 0;      /* เอา padding เดิมออกเพื่อจัดระยะด้วย margin */
        background-color: #94a3b8;
      }

      /* toggle-knob (วงกลมเล็กลง) */
      .toggle-pill .toggle-knob {
        width: 16px;     /* ลดขนาดวงกลม */
        height: 16px;    /* ลดขนาดวงกลม */
        border-radius: 50%;
        background: #ffffff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        position: absolute;
        top: 3px;        /* จัดกึ่งกลางแนวตั้ง (22-16)/2 = 3 */
        transition: left 0.25s ease, right 0.25s ease;
      }

      /* toggle-label (ข้อความ) */
      .toggle-label {
        display: inline-block;
        color: #ffffff;
        font-size: 10px; /* ลดขนาดฟอนต์เล็กน้อย */
        font-weight: 600;
        pointer-events: none;
        transition: margin 0.25s ease; /* เพิ่ม transition ให้ข้อความขยับนุ่มนวล */
      }

      /* --- สถานะ: SHOWN (สีเขียว / เปิด) --- */
      /* ปุ่มอยู่ขวา -> ข้อความต้องอยู่ซ้าย */
      .toggle-pill[data-state="shown"] {
        background-color: #22c55e;
      }
      .toggle-pill[data-state="shown"] .toggle-knob {
        left: auto;
        right: 3px; /* ชิดขวา */
      }
      .toggle-pill[data-state="shown"] .toggle-label {
        margin-right: 14px; /* ดันข้อความไปทางซ้าย หนีจากปุ่ม */
        margin-left: 0;
      }

      /* --- สถานะ: HIDDEN (สีเทา / ปิด) --- */
      /* ปุ่มอยู่ซ้าย -> ข้อความต้องอยู่ขวา */
      .toggle-pill[data-state="hidden"] {
        background-color: #94a3b8;
      }
      .toggle-pill[data-state="hidden"] .toggle-knob {
        left: 3px;  /* ชิดซ้าย */
        right: auto;
      }
      .toggle-pill[data-state="hidden"] .toggle-label {
        margin-left: 14px; /* ดันข้อความไปทางขวา หนีจากปุ่ม */
        margin-right: 0;
      }

      /* Tag แบบ C (pill) สำหรับลุ่มน้ำ / จังหวัด */
      .tag-pill {
        display: inline-flex;
        align-items: center;
        padding: 0.1rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        background-color: #dbeafe; /* blue-100 */
        color: #1d4ed8; /* blue-700 */
        cursor: default;
        margin-right: 0.1rem;
        position: relative;
        z-index: 10;
      }
      .tag-pill .tag-text {
        margin-right: 0.25rem;
      }
      .tag-pill .tag-remove {
        font-weight: 600;
        cursor: pointer;
      }
    </style>
  </head>
  <body class="min-h-screen bg-slate-100">
    <div class="mx-auto max-w-5xl px-4 py-8 sm:px-6 lg:px-8">
      <div
        class="rounded-2xl bg-white shadow-lg px-4 py-5 sm:px-6 sm:py-6 lg:px-8"
      >
        <header class="border-b border-slate-200 pb-3 mb-5">
          <div class="flex items-center gap-4">
            <img
              src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Emblem_of_the_Office_of_the_National_Water_Resources.svg/1014px-Emblem_of_the_Office_of_the_National_Water_Resources.svg.png"
              alt="สทนช. Emblem"
              class="h-12 w-12 object-contain"
            />
            <div>
              <h1 class="text-xl sm:text-2xl font-semibold text-slate-800">
                แบบฟอร์มสำรวจขข้อมูลความสูงภูมิประเทศเชิงเลขของหน่วยงานรัฐในประเทศไทย
              </h1>
              <p class="mt-1 text-sm text-slate-600">
                ความสูงภูมิประเทศเชิงเลข (Digital Elevation Model, DEM)
              </p>
            </div>
          </div>
        </header>

        <form id="demSurveyForm" class="space-y-7" novalidate>
          <!-- ส่วนที่ 1 -->
          <section>
            <h2
              class="text-lg font-semibold text-slate-800 mb-3 border-l-4 border-blue-600 pl-3"
            >
              ส่วนที่ 1 : ข้อมูลพื้นฐานของหน่วยงาน
            </h2>

            <div class="flex flex-col gap-3 sm:flex-row mb-2">
              <div class="sm:flex-1">
                <label
                  for="agencyName"
                  class="block text-sm font-medium text-slate-700 mb-0.5"
                  >ชื่อหน่วยงาน</label
                >
                <input
                  type="text"
                  id="agencyName"
                  name="agencyName"
                  class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="เช่น สำนักงานทรัพยากรน้ำแห่งชาติ (สทนช.)"
                />
              </div>

              <div class="sm:flex-1">
                <label
                  for="subUnit"
                  class="block text-sm font-medium text-slate-700 mb-0.5"
                  >หน่วยงานย่อย / สำนัก / กอง</label
                >
                <input
                  type="text"
                  id="subUnit"
                  name="subUnit"
                  class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                  placeholder="เช่น กองวิจัยและพัฒนา"
                />
              </div>
            </div>

            <fieldset
              class="border border-slate-300 rounded-lg p-3 bg-slate-50/30"
            >
              <legend class="px-2 text-sm font-semibold text-slate-700">
                ผู้ประสานงาน
              </legend>

              <div class="grid gap-3 sm:grid-cols-2">
                <div>
                  <label
                    for="contactName"
                    class="block text-sm font-medium text-slate-700"
                    >(คำนำหน้า) ชื่อ – สกุล</label
                  >
                  <input
                    type="text"
                    id="contactName"
                    name="contactName"
                    class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น นายสมชาย ใจดี"
                  />
                </div>

                <div>
                  <label
                    for="contactPosition"
                    class="block text-sm font-medium text-slate-700"
                    >ตำแหน่ง</label
                  >
                  <input
                    type="text"
                    id="contactPosition"
                    name="contactPosition"
                    class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น วิศวกร"
                  />
                </div>

                <div>
                  <label
                    for="contactPhone"
                    class="block text-sm font-medium text-slate-700"
                    >เบอร์โทรศัพท์</label
                  >
                  <input
                    type="tel"
                    id="contactPhone"
                    name="contactPhone"
                    inputmode="numeric"
                    class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น xx-xxx-xxxx หรือ xxx-xxx-xxxx"
                  />
                </div>

                <div>
                  <label
                    for="contactEmail"
                    class="block text-sm font-medium text-slate-700"
                    >อีเมล</label
                  >
                  <input
                    type="email"
                    id="contactEmail"
                    name="contactEmail"
                    class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น email@example.go.th"
                  />
                </div>
              </div>
            </fieldset>
          </section>

          <hr class="border-slate-200" />

          <!-- ส่วนที่ 2 -->
          <section>
            <div
              class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-4"
            >
              <div>
                <h2
                  class="text-lg font-semibold text-slate-800 border-l-4 border-blue-600 pl-3"
                >
                  ส่วนที่ 2 : รายการข้อมูล DEM ที่หน่วยงานมี
                </h2>
              </div>
              <button
                type="button"
                id="btnAddDemItem"
                class="inline-flex items-center justify-center rounded-lg border border-blue-600 bg-blue-600 px-2.5 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-blue-700 active:bg-blue-800 transition-colors gap-2"
              >
                <i class="fa-solid fa-file-circle-plus"></i>
                <span>เพิ่มชุดข้อมูล</span>
              </button>
            </div>

            <div id="demItemsContainer" class="space-y-5">
              <div
                class="dem-item rounded-xl border border-slate-300 bg-slate-50 px-3 py-4 sm:px-4 sm:py-4 relative"
              >
                <div
                  class="flex items-center justify-between gap-2 mb-3 border-b border-slate-200 pb-2"
                >
                  <h3
                    class="text-sm font-bold text-slate-700 flex items-center gap-2"
                  >
                    ชุดข้อมูลที่ 1
                    <button
                      type="button"
                      class="btn-remove-dem-item inline-flex items-center justify-center rounded-md border border-rose-300 bg-white px-1 py-0.5 text-xm font-medium text-rose-600 hover:bg-rose-500 hover:text-white transition shadow-sm hidden"
                      title="ลบชุดข้อมูลนี้"
                    >
                      <i class="fa-solid fa-xmark mr-1"> </i>
                      <span class="mr-1">ลบชุดข้อมูล</span>
                    </button>
                  </h3>
                  <div class="flex items-center gap-2">
                    <span
                      class="text-[11px] text-slate-500 hidden sm:inline"
                      >ทั้งหมด</span
                    >
                    <button
                      type="button"
                      class="item-toggle-all toggle-pill"
                      data-state="hidden"
                    >
                      <span class="toggle-knob"></span>
                      <span class="toggle-label">แสดง</span>
                    </button>
                  </div>
                </div>

                <div class="space-y-4">
                  <!-- A. ข้อมูลทั่วไป -->
                  <div
                    class="section-card rounded-lg bg-white border border-slate-200 px-3 py-3 space-y-3 shadow-sm"
                  >
                    <div
                      class="section-header flex items-center justify-between select-none"
                    >
                      <p class="text-sm font-semibold text-slate-800">
                        A. ข้อมูลทั่วไป
                      </p>
                      <button
                        type="button"
                        class="section-toggle toggle-pill"
                        data-state="shown"
                      >
                        <span class="toggle-knob"></span>
                        <span class="toggle-label">ซ่อน</span>
                      </button>
                    </div>
                    <div class="section-body space-y-3">
                      <div class="flex flex-col gap-3 sm:flex-row sm:items-start">
  
                      <div class="sm:flex-1">
                        <label
                          class="block text-sm font-medium text-slate-700 mb-1"
                          >1. ชื่อชุดข้อมูล DEM</label
                        >
                        <input
                          type="text"
                          name="demName[]"
                          class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          placeholder="เช่น LiDAR พ.ศ. 2566 พื้นที่ลุ่มน้ำบางปะกง หรือชื่อโครงการจัดทำ DEM"
                        />
                      </div>
                    
                      <div class="sm:basis-[30%]">
                        <label
                          class="block text-sm font-medium text-slate-700 mb-1"
                          >2. แหล่งที่มา / ผู้ผลิตข้อมูล</label
                        >
                        <select
                          name="sourceType[]"
                          class="source-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                          <option value="">-- เลือกแหล่งที่มา --</option>
                          <option value="self">หน่วยงานผลิตเอง</option>
                          <option value="rtsd">กรมแผนที่ทหาร</option>
                          <option value="gistda">GISTDA</option>
                          <option value="ldd">กรมพัฒนาที่ดิน</option>
                          <option value="other">อื่น ๆ (ระบุ)</option>
                        </select>
                        
                        <div class="source-other-wrapper mt-2 hidden">
                          <input
                            type="text"
                            name="sourceOther[]"
                            class="source-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="ระบุหน่วยงาน / บริษัท"
                            disabled
                          />
                        </div>
                      </div>
                    
                      <div class="sm:basis-[10%] sm:max-w-[96px]">
                        <label
                          class="block text-sm font-medium text-slate-700 mb-1"
                          >3. ปีที่จัดทำ</label
                        >
                        <select
                          name="year[]"
                          class="year-select block w-full rounded-md border border-slate-300 bg-white px-2 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                          <option value="">พ.ศ.</option>
                        </select>
                      </div>
                    </div>

                      <!-- 4. พื้นที่ครอบคลุม -->
                      <div>
                        <p
                          class="block text-sm font-medium text-slate-700 mb-1"
                        >
                          4. พื้นที่ครอบคลุม (เลือกระบุได้เพียงรูปแบบเดียว)
                        </p>

                        <div class="space-y-1 text-sm">
                          <!-- ประเทศไทยทั้งหมด -->
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="coverageCountry[]"
                              value="thailand_all"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>ประเทศไทยทั้งหมด</span>
                          </label>

                          <!-- ลุ่มน้ำ -->
                          <div class="space-y-1">
                            <div class="inline-flex flex-wrap items-center gap-2">
                              <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input
                                  type="checkbox"
                                  class="toggle-basin h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                                />
                                <span>ลุ่มน้ำ (สามารถระบุได้หลายค่า)</span>
                              </label>
                              
                              <div class="basin-tags flex flex-wrap items-center gap-1"></div>
                            </div>
                          
                            <div class="basin-block mt-1 hidden">
                              <input
                                type="text"
                                class="basin-search mb-1 block w-full rounded-md border border-slate-300 bg-white px-3 py-1 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="พิมพ์เพื่อค้นหาลุ่มน้ำ"
                              />
                              <select
                                name="coverageBasin[]"
                                multiple
                                class="basin-select block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              >
                                </select>
                              <p class="mt-1 text-xm text-slate-500">
                                * Double Click เพื่อเพิ่ม/ลบ ลุ่มน้ำ
                              </p>
                              <input
                                type="hidden"
                                name="coverageBasinOther[]"
                                class="basin-other-input"
                              />
                            </div>
                          </div>

                          <!-- จังหวัด -->
                          <div class="space-y-1">
                            <div class="inline-flex flex-wrap items-center gap-2">
                              <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input
                                  type="checkbox"
                                  class="toggle-province h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                                />
                                <span>จังหวัด (สามารถระบุได้หลายค่า)</span>
                              </label>
                          
                              <div class="province-tags flex flex-wrap items-center gap-1"></div>
                            </div>
                          
                            <div class="province-block mt-1 hidden">
                              <input
                                type="text"
                                class="province-search mb-1 block w-full rounded-md border border-slate-300 bg-white px-3 py-1 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="พิมพ์เพื่อค้นหาจังหวัด"
                              />
                              <select
                                name="coverageProvince[]"
                                multiple
                                class="province-select block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              >
                                </select>
                              <p class="mt-1 text-xm text-slate-500">
                                * Double Click เพื่อเพิ่ม/ลบ จังหวัด
                              </p>
                              <input
                                type="hidden"
                                name="coverageProvinceOther[]"
                                class="province-other-input"
                              />
                            </div>
                          </div>

                          <!-- พื้นที่เฉพาะจุด -->
                          <div class="space-y-1">
                            <label class="inline-flex items-center gap-2">
                              <input
                                type="checkbox"
                                class="toggle-local h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                              />
                              <span>พื้นที่เฉพาะจุด</span>
                            </label>
                            <div class="local-block mt-1 hidden">
                              <input
                                type="text"
                                name="coverageLocal[]"
                                class="local-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:cursor-not-allowed"
                                placeholder="เช่น เขตเทศบาลเมืองหาดใหญ่"
                                disabled
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- B. รายละเอียดทางเทคนิค -->
                  <div
                    class="section-card rounded-lg bg-white border border-slate-200 px-3 py-3 space-y-3 shadow-sm"
                  >
                    <div
                      class="section-header flex items-center justify-between select-none"
                    >
                      <p class="text-sm font-semibold text-slate-800">
                        B. รายละเอียดทางเทคนิค
                      </p>
                      <button
                        type="button"
                        class="section-toggle toggle-pill"
                        data-state="hidden"
                      >
                        <span class="toggle-knob"></span>
                        <span class="toggle-label">แสดง</span>
                      </button>
                    </div>
                    <div class="section-body space-y-3 hidden">
                      <div class="flex flex-col gap-3 lg:flex-row lg:items-start lg:flex-nowrap">
                        <div class="lg:flex-1 min-w-[160px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">5. Resolution</label>
                          <select
                            name="resolution[]"
                            class="resolution-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="">-- เลือก Resolution --</option>
                            <option value="30m">30 m</option>
                            <option value="10m">10 m</option>
                            <option value="5m">5 m</option>
                            <option value="1m">1 m</option>
                            <option value="lidar_sub1m">ต่ำกว่า 1 m (LiDAR / ระบุ)</option>
                            <option value="other">อื่น ๆ (ระบุ)</option>
                          </select>
                          <div class="resolution-other-wrapper mt-2 hidden">
                            <input
                              type="text"
                              name="resolutionOther[]"
                              class="resolution-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="เช่น 0.5 m หรือรายละเอียดเพิ่มเติม"
                              disabled
                            />
                          </div>
                        </div>
                      
                        <div class="lg:flex-1 min-w-[140px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">6. Vertical Accuracy (ม.)</label>
                          <input
                            type="number"
                            step="0.01"
                            name="verticalAccuracy[]"
                            class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="เช่น 0.15"
                          />
                        </div>
                      
                        <div class="lg:flex-1 min-w-[140px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">7. Horizontal Accuracy (ม.)</label>
                          <input
                            type="number"
                            step="0.01"
                            name="horizontalAccuracy[]"
                            class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="เช่น 0.30"
                          />
                        </div>
                      </div>

                      <div class="flex flex-col gap-3 lg:flex-row lg:items-start lg:flex-nowrap">
                        <div class="lg:basis-1/2 min-w-[160px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">8. Vertical Datum</label>
                          <select
                            name="verticalDatum[]"
                            class="vertical-datum-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="">-- เลือก Vertical Datum --</option>
                            <option value="MSL">MSL</option>
                            <option value="EGM96">EGM96</option>
                            <option value="other">อื่น ๆ (ระบุ)</option>
                          </select>
                          <div class="vertical-datum-other-wrapper mt-2 hidden">
                            <input
                              type="text"
                              name="verticalDatumOther[]"
                              class="vertical-datum-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="ระบุ Datum อื่น ๆ"
                              disabled
                            />
                          </div>
                        </div>
                      
                        <div class="lg:basis-1/2 min-w-[160px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">9. Coordinate System</label>
                          <select
                            name="coordSys[]"
                            class="coord-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="">-- เลือก Coordinate System --</option>
                            <option value="WGS84">WGS84</option>
                            <option value="UTM47N">UTM 47N</option>
                            <option value="UTM48N">UTM 48N</option>
                            <option value="other">อื่น ๆ (ระบุ)</option>
                          </select>
                          <div class="coord-other-wrapper mt-2 hidden">
                            <input
                              type="text"
                              name="coordSysOther[]"
                              class="coord-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="ระบุระบบพิกัดอื่น ๆ"
                              disabled
                            />
                          </div>
                        </div>
                      </div>

                      <!-- 10 fieldset -->
                      <fieldset
                        class="border border-slate-200 rounded-lg px-3 py-3"
                      >
                        <legend
                          class="block text-sm font-medium text-slate-700"
                        >
                          10. วิธีการจัดทำ DEM (สามารถระบุได้หลายค่า)
                        </legend>
                        <div class="flex flex-wrap gap-3 text-sm">
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="demMethodLidar[]"
                              value="LiDAR"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>LiDAR</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="demMethodUav[]"
                              value="UAV Photogrammetry"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>UAV Photogrammetry</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="demMethodAlos[]"
                              value="ALOS"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>ALOS</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="demMethodSrtm[]"
                              value="SRTM"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>SRTM</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="demMethodTanDEM[]"
                              value="TanDEM-X"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>TanDEM-X</span>
                          </label>

                          <label
                            class="inline-flex items-center gap-2 flex-1 min-w-[220px]"
                          >
                            <input
                              type="checkbox"
                              name="demMethodOtherFlag[]"
                              value="other"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>อื่น ๆ</span>
                            <input
                              type="text"
                              name="demMethodOther[]"
                              class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="ระบุวิธีการจัดทำ DEM"
                            />
                          </label>
                        </div>
                      </fieldset>
                    </div>
                  </div>

                  <!-- C. รูปแบบไฟล์และการเข้าถึง -->
                  <div
                    class="section-card rounded-lg bg-white border border-slate-200 px-3 py-3 space-y-3 shadow-sm"
                  >
                    <div
                      class="section-header flex items-center justify-between select-none"
                    >
                      <p class="text-sm font-semibold text-slate-800">
                        C. รูปแบบไฟล์และการเข้าถึง
                      </p>
                      <button
                        type="button"
                        class="section-toggle toggle-pill"
                        data-state="hidden"
                      >
                        <span class="toggle-knob"></span>
                        <span class="toggle-label">แสดง</span>
                      </button>
                    </div>
                    <div class="section-body space-y-3 hidden">
                      <!-- 11 fieldset -->
                      <fieldset
                        class="border border-slate-200 rounded-lg px-3 py-3"
                      >
                        <legend
                          class="block text-sm font-medium text-slate-700"
                        >
                          11. File Format (สามารถระบุได้หลายค่า)
                        </legend>
                        <div class="flex flex-wrap gap-3 text-sm">
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="formatGeoTIFF[]"
                              value="GeoTIFF"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>GeoTIFF</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="formatIMG[]"
                              value="IMG"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>IMG</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="formatASC[]"
                              value="ASC"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>ASC</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="formatLAS[]"
                              value="LAS/LAZ"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>LAS/LAZ</span>
                          </label>

                          <label
                            class="inline-flex items-center gap-2 flex-1 min-w-[220px]"
                          >
                            <input
                              type="checkbox"
                              name="formatOtherFlag[]"
                              value="other"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>อื่น ๆ</span>
                            <input
                              type="text"
                              name="formatOther[]"
                              class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="ระบุรูปแบบไฟล์อื่น ๆ"
                            />
                          </label>
                        </div>
                      </fieldset>

                      <!-- 12 + 13 ในบรรทัดเดียวกัน -->
                      <div class="flex flex-col gap-3 md:flex-row md:items-start md:flex-wrap">
                        <div class="md:flex-1 md:min-w-[220px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">12. ขนาดไฟล์</label>
                          <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                            <div class="w-full sm:w-1/2">
                              <input
                                type="number"
                                step="0.01"
                                name="fileSize[]"
                                class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="เช่น 120"
                              />
                            </div>
                            <div class="w-full sm:w-1/2">
                              <select
                                name="fileSizeUnit[]"
                                class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              >
                                <option value="">-- หน่วย --</option>
                                <option value="TB">TB</option>
                                <option value="GB">GB</option>
                                <option value="MB">MB</option>
                                <option value="KB">KB</option>
                              </select>
                            </div>
                          </div>
                        </div>
                      
                        <div class="md:flex-1 md:min-w-[220px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">13. ลิขสิทธิ์</label>
                          <select
                            name="license[]"
                            class="license-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="">-- เลือกลิขสิทธิ์ --</option>
                            <option value="open">Open Data</option>
                            <option value="internal">Internal</option>
                            <option value="exchange">Exchange</option>
                            <option value="restricted">Security Restricted</option>
                            <option value="other">อื่น ๆ (ระบุ)</option>
                          </select>
                          <div class="license-other-wrapper mt-2 hidden">
                            <input
                              type="text"
                              name="licenseOther[]"
                              class="license-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="ระบุประเภทลิขสิทธิ์อื่น ๆ"
                              disabled
                            />
                          </div>
                        </div>
                      </div>

                      <!-- 14 fieldset -->
                      <fieldset
                        class="border border-slate-200 rounded-lg px-3 py-3"
                      >
                        <legend
                          class="block text-sm font-medium text-slate-700"
                        >
                          14. ช่องทางการเข้าถึง (สามารถระบุได้หลายค่า)
                        </legend>
                        <div class="flex flex-wrap gap-3 text-sm">
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="accessWeb[]"
                              value="web"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>เว็บดาวน์โหลด</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="accessOfficial[]"
                              value="official_letter"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>หนังสือราชการ</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="accessMou[]"
                              value="mou_nda"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>MOU / NDA</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="accessInternal[]"
                              value="internal"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>ภายในหน่วยงาน</span>
                          </label>

                          <label
                            class="inline-flex items-center gap-2 flex-1 min-w-[220px]"
                          >
                            <input
                              type="checkbox"
                              name="accessOtherFlag[]"
                              value="other"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>อื่น ๆ</span>
                            <input
                              type="text"
                              name="accessOther[]"
                              class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="ระบุช่องทางอื่น ๆ"
                            />
                          </label>
                        </div>
                      </fieldset>
                    </div>
                  </div>

                  <!-- D. คุณภาพและการใช้งาน -->
                  <div
                    class="section-card rounded-lg bg-white border border-slate-200 px-3 py-3 space-y-3 shadow-sm"
                  >
                    <div
                      class="section-header flex items-center justify-between select-none"
                    >
                      <p class="text-sm font-semibold text-slate-800">
                        D. คุณภาพและการใช้งาน
                      </p>
                      <button
                        type="button"
                        class="section-toggle toggle-pill"
                        data-state="hidden"
                      >
                        <span class="toggle-knob"></span>
                        <span class="toggle-label">แสดง</span>
                      </button>
                    </div>
                    <div class="section-body space-y-3 hidden">
                      <!-- 15 fieldset -->
                      <fieldset
                        class="border border-slate-200 rounded-lg px-3 py-3"
                      >
                        <legend
                          class="block text-sm font-medium text-slate-700"
                        >
                          15. QC/QA (สามารถระบุได้หลายค่า)
                        </legend>
                        <div class="flex flex-wrap gap-3 text-sm">
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="qcNone[]"
                              value="none"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>ไม่มี</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="qcGcp[]"
                              value="GCP"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>GCP</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="qcOtherDEM[]"
                              value="compare_dem"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>เปรียบเทียบ DEM อื่น</span>
                          </label>
                          <label
                            class="inline-flex items-center gap-2 flex-1 min-w-[220px]"
                          >
                            <input
                              type="checkbox"
                              name="qcOtherFlag[]"
                              value="other"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>อื่น ๆ</span>
                            <input
                              type="text"
                              name="qcOther[]"
                              class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="ระบุวิธี QC/QA อื่น ๆ"
                            />
                          </label>
                        </div>
                      </fieldset>

                      <!-- 16 fieldset -->
                      <fieldset
                        class="border border-slate-200 rounded-lg px-3 py-3"
                      >
                        <legend
                          class="block text-sm font-medium text-slate-700"
                        >
                          16. การใช้งานหลัก (สามารถระบุได้หลายค่า)
                        </legend>
                        <div class="flex flex-wrap gap-3 text-sm">
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="useFlood[]"
                              value="flood"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>น้ำท่วม</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="useSubBasin[]"
                              value="sub_basin"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>ลุ่มน้ำย่อย</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="useUrbanPlan[]"
                              value="urban_planning"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>ผังเมือง</span>
                          </label>
                          <label class="inline-flex items-center gap-2">
                            <input
                              type="checkbox"
                              name="useModel[]"
                              value="models"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>แบบจำลอง RRI / HEC / MIKE</span>
                          </label>

                          <label
                            class="inline-flex items-center gap-2 flex-1 min-w-[220px]"
                          >
                            <input
                              type="checkbox"
                              name="useOtherFlag[]"
                              value="other"
                              class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"
                            />
                            <span>อื่น ๆ</span>
                            <input
                              type="text"
                              name="useOther[]"
                              class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="ระบุการใช้งานอื่น ๆ"
                            />
                          </label>
                        </div>
                      </fieldset>

                      <!-- 17 -->
                      <div>
                        <label
                          class="block text-sm font-medium text-slate-700 mb-1"
                          >17. หมายเหตุ</label
                        >
                        <textarea
                          name="remark[]"
                          rows="1"
                          style="resize: vertical; min-height: 2.5rem;"
                          class="block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                          placeholder="ระบุหมายเหตุเพิ่มเติม เช่น ปัญหาในการใช้งาน, ข้อจำกัด, แผนการปรับปรุงในอนาคต"
                        ></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <div
            class="flex flex-col gap-3 pt-4 border-t border-slate-200 sm:flex-row sm:items-center sm:justify-end"
          >
            <button
              type="reset"
              id="btnResetForm"
              class="inline-flex items-center justify-center rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 active:bg-slate-100"
            >
              ล้างค่า
            </button>
            <button
              type="submit"
              id="btnSubmitForm"
              class="inline-flex items-center justify-center rounded-lg border border-blue-600 bg-blue-600 px-5 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 active:bg-blue-800"
            >
              บันทึกแบบฟอร์ม
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Popup ยืนยัน -->
    <div
      id="confirmModal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/40"
    >
      <div
        class="bg-white rounded-2xl shadow-xl max-w-sm w-full mx-4 p-5 border border-slate-200"
      >
        <h3
          id="confirmTitle"
          class="text-base font-semibold text-slate-800 mb-1"
        ></h3>
        <p
          id="confirmMessage"
          class="text-sm text-slate-600 mb-4 leading-relaxed"
        ></p>
        <div class="flex justify-end gap-2">
          <button
            type="button"
            id="confirmCancel"
            class="inline-flex items-center justify-center rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50"
          >
            ยกเลิก
          </button>
          <button
            type="button"
            id="confirmOk"
            class="inline-flex items-center justify-center rounded-lg border border-blue-600 bg-blue-600 px-4 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-700"
          >
            ยืนยัน
          </button>
        </div>
      </div>
    </div>

    <div
      id="confirmModal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-900/60 transition-opacity"
    >
      <div
        class="bg-white rounded-2xl shadow-xl w-full max-w-[400px] mx-4 p-6 transform transition-all"
      >
        <h3
          id="confirmTitle"
          class="text-xl font-bold text-gray-900 mb-2 text-left"
        >
          ยืนยันล้างข้อมูล
        </h3>

        <p
          id="confirmMessage"
          class="text-base text-gray-600 mb-8 text-left leading-relaxed"
        >
          คุณต้องการล้างค่าทั้งหมดในแบบฟอร์มหรือไม่?
        </p>

        <div class="flex justify-end gap-3">
          <button
            type="button"
            id="confirmCancel"
            class="px-5 py-2.5 rounded-lg border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 transition-colors"
          >
            ยกเลิก
          </button>
          <button
            type="button"
            id="confirmOk"
            class="px-5 py-2.5 rounded-lg bg-blue-600 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm transition-colors"
          >
            ยืนยัน
          </button>
        </div>
      </div>
    </div>

    <script>
      // ★★ ใส่ URL Web App ของ Apps Script ที่นี่ ★★
      const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw8Wf9vZsQbksaG7dmtWxw2b26xzCxI0Rl1lTlWggIS_rlULBL-wkOjDgRBZuH_vWI5Lw/exec";
    
      const demContainer = document.getElementById("demItemsContainer");
      const btnAddDemItem = document.getElementById("btnAddDemItem");
      const form = document.getElementById("demSurveyForm");
    
      // -------------------- บังคับกรอก ส่วนที่ 1 (ข้อมูลหน่วยงาน) --------------------
      const requiredAgencyIds = [
        "agencyName",
        "subUnit",
        "contactName",
        "contactPosition",
        "contactPhone",
        "contactEmail",
      ];
      requiredAgencyIds.forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.required = true;
      });
    
      // -------------------- ฟอร์แมตและตรวจสอบเบอร์โทร --------------------
      (function setupPhoneValidation() {
        const phoneInput = document.getElementById("contactPhone");
        if (!phoneInput) return;
    
        function validatePhone() {
          const digits = phoneInput.value.replace(/\D/g, "");
          if (!digits) {
            phoneInput.setCustomValidity("");
            return;
          }
          if (digits.length !== 9 && digits.length !== 10) {
            phoneInput.setCustomValidity("กรุณากรอกหมายเลขโทรศัพท์ 9 หรือ 10 หลัก (ไม่ต้องใส่ขีด)");
          } else {
            phoneInput.setCustomValidity("");
          }
        }
    
        function formatPhone() {
          const digits = phoneInput.value.replace(/\D/g, "");
          if (digits.length === 9) {
            phoneInput.value = digits.replace(/^(\d{2})(\d{3})(\d{4})$/, "$1-$2-$3");
          } else if (digits.length === 10) {
            phoneInput.value = digits.replace(/^(\d{3})(\d{3})(\d{4})$/, "$1-$2-$3");
          }
        }
    
        phoneInput.addEventListener("input", validatePhone);
        phoneInput.addEventListener("blur", () => {
          validatePhone();
          formatPhone();
        });
      })();
    
      // -------------------- Confirm Modal --------------------
      const confirmModal = document.getElementById("confirmModal");
      const confirmTitle = document.getElementById("confirmTitle");
      const confirmMessage = document.getElementById("confirmMessage");
      const confirmCancel = document.getElementById("confirmCancel");
      const confirmOk = document.getElementById("confirmOk");
      let confirmCallback = null;
    
      function openConfirmModal(title, message, onConfirm) {
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmCallback = onConfirm;
        confirmModal.classList.remove("hidden");
        confirmModal.classList.add("flex");
      }
    
      function closeConfirmModal() {
        confirmModal.classList.add("hidden");
        confirmModal.classList.remove("flex");
        confirmCallback = null;
      }
    
      confirmCancel.addEventListener("click", closeConfirmModal);
      confirmOk.addEventListener("click", () => {
        if (typeof confirmCallback === "function") {
          confirmCallback();
        }
        closeConfirmModal();
      });
      confirmModal.addEventListener("click", (e) => {
        if (e.target === confirmModal) {
          closeConfirmModal();
        }
      });
    
// -------------------- Success Modal Control --------------------
      const successModal = document.getElementById("successModal");
      const successOk = document.getElementById("successOk");

      function openSuccessModal() {
        if (!successModal) return;
        // ลบ hidden เพื่อแสดง และจัด layout เป็น flex เพื่อให้ content อยู่กลางจอ
        successModal.classList.remove("hidden");
        successModal.classList.add("flex");
        
        // (Optional) สั่งให้ปุ่ม OK โฟกัสทันที เพื่อให้กด Enter ปิดได้เลย
        if(successOk) successOk.focus();
      }

      function closeSuccessModal() {
        if (!successModal) return;
        successModal.classList.add("hidden");
        successModal.classList.remove("flex");
      }

      // ผูก Event ปุ่มกดปิด
      if (successOk) {
        successOk.addEventListener("click", closeSuccessModal);
      }
      // กดพื้นหลังเพื่อปิด
      if (successModal) {
        successModal.addEventListener("click", (e) => {
           // ปิดเฉพาะตอนคลิกที่พื้นหลัง (backdrop) ไม่ใช่คลิกที่กล่อง
           if (e.target === successModal) { 
             closeSuccessModal(); 
           }
        });
      }
    
      // ปิด modal ด้วย ESC (ทั้ง confirm + success)
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeConfirmModal();
          closeSuccessModal();
        }
      });
    
      // -------------------- Year Select (2539–2568) --------------------
      function populateYearSelects() {
        const selects = document.querySelectorAll(".year-select");
        const startBE = 2539;
        const endBE = 2568;
    
        selects.forEach((sel) => {
          // ถ้ามี option > 1 (มีข้อมูลแล้ว) ไม่ต้องเติมซ้ำ
          if (sel.options.length > 1) return;
          for (let y = endBE; y >= startBE; y--) {
            const opt = document.createElement("option");
            opt.value = y;
            opt.textContent = y.toString();
            sel.appendChild(opt);
          }
          // ให้ฟอนต์/ขนาดใกล้เคียงกับกล่องข้าง ๆ
          sel.classList.add("text-sm");
        });
      }
    
      // -------------------- DEM Index (ข้อมูลชุดที่ X) --------------------
      function updateDemIndexes() {
        const items = demContainer.querySelectorAll(".dem-item");
        items.forEach((item, index) => {
          const idx = index + 1;
    
          // เอา badge #1 ออก
          const badge = item.querySelector(".dem-index");
          if (badge) {
            badge.style.display = "none";
          }
    
          // ปรับข้อความ "ชุดข้อมูลที่ X" ให้ dynamic
          const header = item.querySelector("h3");
          if (header) {
            let titleSpan = header.querySelector(".dem-title-text");
            if (!titleSpan) {
              titleSpan = document.createElement("span");
              titleSpan.className = "dem-title-text";
              titleSpan.style.marginLeft = "4px";
    
              // ลบ text node เดิมใน h3 (เช่น "ข้อมูลชุดที่ 1")
              const toRemove = [];
              header.childNodes.forEach((node) => {
                if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                  toRemove.push(node);
                }
              });
              toRemove.forEach((n) => header.removeChild(n));
    
              const removeBtn = header.querySelector(".btn-remove-dem-item");
              if (removeBtn) {
                header.insertBefore(titleSpan, removeBtn);
              } else {
                header.appendChild(titleSpan);
              }
            }
            titleSpan.textContent = `ชุดข้อมูลที่ ${idx}`;
          }
    
          const removeBtn = item.querySelector(".btn-remove-dem-item");
          if (removeBtn) {
            if (items.length === 1) {
              removeBtn.classList.add("hidden");
            } else {
              removeBtn.classList.remove("hidden");
            }
            // ปรับปุ่มลบให้พื้นหลังแดง ตัวหนังสือขาว
            removeBtn.classList.add("bg-rose-600", "text-white", "border", "border-rose-600", "hover:bg-rose-700");
            removeBtn.classList.remove("bg-white");
          }
        });
      }
    
      // -------------------- แสดง/ซ่อน Section Card ในแต่ละ DEM --------------------
      function setSectionVisibility(card, visible) {
        const body = card.querySelector(".section-body");
        const toggleBtn = card.querySelector(".section-toggle");
        if (!body || !toggleBtn) return;
        const label = toggleBtn.querySelector(".toggle-label");
        if (visible) {
          body.classList.remove("hidden");
          toggleBtn.dataset.state = "shown";
          if (label) label.textContent = "ซ่อน";
        } else {
          body.classList.add("hidden");
          toggleBtn.dataset.state = "hidden";
          if (label) label.textContent = "แสดง";
        }
      }
    
      function attachSectionToggles(item) {
        const cards = item.querySelectorAll(".section-card");
    
        // เริ่มต้น: แสดงเฉพาะ A
        cards.forEach((card, idx) => {
          setSectionVisibility(card, idx === 0);
        });
    
        cards.forEach((card) => {
          const body = card.querySelector(".section-body");
          const toggleBtn = card.querySelector(".section-toggle");
          if (!body || !toggleBtn) return;
    
          toggleBtn.addEventListener("click", () => {
            const currentlyHidden = body.classList.contains("hidden");
            setSectionVisibility(card, currentlyHidden);
          });
        });
    
        const itemToggle = item.querySelector(".item-toggle-all");
        if (itemToggle) {
          const labelAll = itemToggle.querySelector(".toggle-label");
    
          const refreshItemToggleState = () => {
            const innerCards = item.querySelectorAll(".section-card");
            const anyHidden = Array.from(innerCards).some((c) =>
              c.querySelector(".section-body").classList.contains("hidden")
            );
            itemToggle.dataset.state = anyHidden ? "hidden" : "shown";
            if (labelAll) labelAll.textContent = anyHidden ? "แสดง" : "ซ่อน";
          };
    
          refreshItemToggleState();
    
          itemToggle.addEventListener("click", () => {
            const makeVisible = itemToggle.dataset.state === "hidden";
            const innerCards = item.querySelectorAll(".section-card");
            innerCards.forEach((card) =>
              setSectionVisibility(card, makeVisible)
            );
            itemToggle.dataset.state = makeVisible ? "shown" : "hidden";
            if (labelAll) labelAll.textContent = makeVisible ? "ซ่อน" : "แสดง";
          });
    
          cards.forEach((card) => {
            const btn = card.querySelector(".section-toggle");
            if (!btn) return;
            btn.addEventListener("click", () => {
              setTimeout(refreshItemToggleState, 0);
            });
          });
        }
      }
    
      // -------------------- Reference data (จังหวัด / ลุ่มน้ำ) --------------------
      let REF_DATA = null;
    
      function populateSelectOptions(selectEl, values) {
        if (!selectEl) return;
        const currentSelected = Array.from(selectEl.options)
          .filter((o) => o.selected)
          .map((o) => o.value);
        selectEl.innerHTML = "";
        (values || []).forEach((val) => {
          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = val;
          if (currentSelected.includes(val)) opt.selected = true;
          selectEl.appendChild(opt);
        });
      }
    
      function applyReferenceDataToAllItems() {
        if (!REF_DATA) return;
        const basins = REF_DATA.basins || [];
        const provinces = REF_DATA.provinces || [];
    
        document
          .querySelectorAll(".basin-select")
          .forEach((sel) => populateSelectOptions(sel, basins));
        document
          .querySelectorAll(".province-select")
          .forEach((sel) => populateSelectOptions(sel, provinces));
      }
    
      async function initReferenceDropdowns() {
        try {
          const resp = await fetch(APPS_SCRIPT_URL + "?action=getReferenceData");
          const data = await resp.json();
          REF_DATA = data || { basins: [], provinces: [] };
          applyReferenceDataToAllItems();
        } catch (err) {
          console.error("getReferenceData error", err);
        }
      }
    
      // -------------------- Helper: อื่น ๆ + checkbox flag --------------------
      function setupOtherWithFlag(item, flagName, inputName) {
        const flag = item.querySelector(`input[name="${flagName}"]`);
        const input = item.querySelector(`input[name="${inputName}"]`);
        if (!flag || !input) return;
    
        const update = () => {
          const on = flag.checked;
          input.disabled = !on;
          if (!on) input.value = "";
        };
    
        flag.addEventListener("change", update);
        update();
      }
    
      // -------------------- Attach handlers ให้ DEM item 1 ใบ --------------------
      function markSectionARequired(item) {
        const demName = item.querySelector('input[name="demName[]"]');
        const sourceSelect = item.querySelector('select[name="sourceType[]"]');
        const yearSelect = item.querySelector('select[name="year[]"]');
        if (demName) demName.required = true;
        if (sourceSelect) sourceSelect.required = true;
        if (yearSelect) yearSelect.required = true;
      }
    
      // -------------------- Attach handlers ให้ DEM item 1 ใบ --------------------
      function attachOtherFieldHandlers(item) {
        if (!item) return;

        // เรียกฟังก์ชันย่อยต่างๆ
        attachSectionToggles(item);
        markSectionARequired(item);

        // ---- Tag Stack Helper ----
        function setupTagStack(selectEl, tagsContainer, hiddenInput) {
          if (!selectEl || !tagsContainer || !hiddenInput) return;
          let values = [];

          function renderTags() {
            tagsContainer.innerHTML = "";
            values.forEach((val) => {
              const span = document.createElement("span");
              span.className = "tag-pill";
              span.dataset.value = val;
              span.innerHTML = `
                <span class="tag-text">${val}</span>
                <span class="tag-remove">×</span>
              `;
              tagsContainer.appendChild(span);
            });
            hiddenInput.value = values.join(", ");
          }

          function addValue(val) {
            const v = (val || "").trim();
            if (!v || values.includes(v)) return;
            values.push(v);
            renderTags();
          }

          function removeValue(val) {
            const idx = values.indexOf(val);
            if (idx === -1) return;
            values.splice(idx, 1);
            renderTags();
          }

          // ดับเบิลคลิกที่ option เพื่อเพิ่มแท็ก
          selectEl.addEventListener("dblclick", () => {
            const opt = selectEl.options[selectEl.selectedIndex];
            const text = opt ? opt.textContent.trim() : "";
            if (!text) return;
            if (values.includes(text)) {
              removeValue(text);
            } else {
              addValue(text);
            }
          });

          // คลิกกากบาทเพื่อลบ
          tagsContainer.addEventListener("click", (e) => {
            const removeBtn = e.target.closest(".tag-remove");
            if (!removeBtn) return;
            e.preventDefault();
            e.stopPropagation();
            const pill = removeBtn.closest(".tag-pill");
            if (!pill) return;
            const v = pill.dataset.value;
            removeValue(v);
          });
        }

        // ---- Search Filter Helper ----
        function setupSearchFilter(selectEl, searchInput) {
          if (!selectEl || !searchInput) return;

          searchInput.addEventListener("input", () => {
            const term = searchInput.value.trim().toLowerCase();
            const opts = Array.from(selectEl.options);
            opts.forEach((opt, idx) => {
              if (idx === 0 && opt.value === "") {
                opt.hidden = false;
                return;
              }
              if (!term) {
                opt.hidden = false;
              } else {
                const match = opt.textContent.toLowerCase().includes(term);
                opt.hidden = !match;
              }
            });
          });
        }

        // ---- Source (แหล่งที่มา) ----
        const sourceSelect = item.querySelector(".source-select");
        const sourceOtherWrapper = item.querySelector(".source-other-wrapper");
        const sourceOtherInput = item.querySelector(".source-other-input");
        if (sourceSelect && sourceOtherWrapper && sourceOtherInput) {
          sourceSelect.addEventListener("change", () => {
            const show = sourceSelect.value === "other";
            sourceOtherWrapper.classList.toggle("hidden", !show);
            sourceOtherInput.disabled = !show;
            if (show) sourceOtherInput.focus();
            else sourceOtherInput.value = "";
          });
          // initial
          const show = sourceSelect.value === "other";
          sourceOtherWrapper.classList.toggle("hidden", !show);
          sourceOtherInput.disabled = !show;
        }

        // ---- Resolution ----
        const resSelect = item.querySelector(".resolution-select");
        const resOtherWrapper = item.querySelector(".resolution-other-wrapper");
        const resOtherInput = item.querySelector(".resolution-other-input");
        if (resSelect && resOtherWrapper && resOtherInput) {
          const updateRes = () => {
            const show =
              resSelect.value === "lidar_sub1m" || resSelect.value === "other";
            resOtherWrapper.classList.toggle("hidden", !show);
            resOtherInput.disabled = !show;
            if (show) resOtherInput.focus();
            else resOtherInput.value = "";
          };
          resSelect.addEventListener("change", updateRes);
          updateRes();
        }

        // ---- Vertical Datum ----
        const vDatumSelect = item.querySelector(".vertical-datum-select");
        const vDatumWrapper = item.querySelector(".vertical-datum-other-wrapper");
        const vDatumInput = item.querySelector(".vertical-datum-other-input");
        if (vDatumSelect && vDatumWrapper && vDatumInput) {
          const updateVD = () => {
            const show = vDatumSelect.value === "other";
            vDatumWrapper.classList.toggle("hidden", !show);
            vDatumInput.disabled = !show;
            if (show) vDatumInput.focus();
            else vDatumInput.value = "";
          };
          vDatumSelect.addEventListener("change", updateVD);
          updateVD();
        }

        // ---- Coordinate System ----
        const coordSelect = item.querySelector(".coord-select");
        const coordWrapper = item.querySelector(".coord-other-wrapper");
        const coordInput = item.querySelector(".coord-other-input");
        if (coordSelect && coordWrapper && coordInput) {
          const updateCoord = () => {
            const show = coordSelect.value === "other";
            coordWrapper.classList.toggle("hidden", !show);
            coordInput.disabled = !show;
            if (show) coordInput.focus();
            else coordInput.value = "";
          };
          coordSelect.addEventListener("change", updateCoord);
          updateCoord();
        }

        // ---- License ----
        const licSelect = item.querySelector(".license-select");
        const licWrapper = item.querySelector(".license-other-wrapper");
        const licInput = item.querySelector(".license-other-input");
        if (licSelect && licWrapper && licInput) {
          const updateLic = () => {
            const show = licSelect.value === "other";
            licWrapper.classList.toggle("hidden", !show);
            licInput.disabled = !show;
            if (show) licInput.focus();
            else licInput.value = "";
          };
          licSelect.addEventListener("change", updateLic);
          updateLic();
        }

        // ---- พื้นที่ครอบคลุม (Logic ใหม่: ไทยปิดหมด / ไม่ใช่ไทยเลือกได้หลายอัน) ----
        const coverageCountryCb = item.querySelector('input[name="coverageCountry[]"]');
        const basinToggle = item.querySelector(".toggle-basin");
        const provinceToggle = item.querySelector(".toggle-province");
        const localToggle = item.querySelector(".toggle-local");

        const basinBlock = item.querySelector(".basin-block");
        const provinceBlock = item.querySelector(".province-block");
        const localBlock = item.querySelector(".local-block");
        const localInput = item.querySelector(".local-input");
        
        // ตัวแปรสำหรับล้างค่า
        const basinTags = item.querySelector(".basin-tags");
        const basinHidden = item.querySelector(".basin-other-input");
        const provinceTags = item.querySelector(".province-tags");
        const provinceHidden = item.querySelector(".province-other-input");

        function updateCoverageGroup() {
          const isCountryChecked = coverageCountryCb && coverageCountryCb.checked;

          if (isCountryChecked) {
            // 1. กรณีเลือก "ประเทศไทยทั้งหมด" -> ปิดและล้างค่าอื่น
            if (basinToggle) { basinToggle.checked = false; basinToggle.disabled = true; }
            if (provinceToggle) { provinceToggle.checked = false; provinceToggle.disabled = true; }
            if (localToggle) { localToggle.checked = false; localToggle.disabled = true; }

            if (basinBlock) basinBlock.classList.add("hidden");
            if (provinceBlock) provinceBlock.classList.add("hidden");
            if (localBlock) localBlock.classList.add("hidden");

            // ล้างค่า
            if (basinTags) basinTags.innerHTML = "";
            if (basinHidden) basinHidden.value = "";
            if (provinceTags) provinceTags.innerHTML = "";
            if (provinceHidden) provinceHidden.value = "";
            if (localInput) { localInput.value = ""; localInput.disabled = true; }
            
          } else {
            // 2. กรณี "ไม่เลือก" ประเทศไทย -> เปิดให้เลือกได้อิสระ
            if (basinToggle) basinToggle.disabled = false;
            if (provinceToggle) provinceToggle.disabled = false;
            if (localToggle) localToggle.disabled = false;

            if (basinBlock && basinToggle) {
              basinBlock.classList.toggle("hidden", !basinToggle.checked);
            }
            if (provinceBlock && provinceToggle) {
              provinceBlock.classList.toggle("hidden", !provinceToggle.checked);
            }
            if (localBlock && localInput && localToggle) {
              const showLocal = localToggle.checked;
              localBlock.classList.toggle("hidden", !showLocal);
              localInput.disabled = !showLocal;
              if (!showLocal) localInput.value = "";
            }
          }
        }

        if (coverageCountryCb) coverageCountryCb.addEventListener("change", updateCoverageGroup);
        if (basinToggle) basinToggle.addEventListener("change", updateCoverageGroup);
        if (provinceToggle) provinceToggle.addEventListener("change", updateCoverageGroup);
        if (localToggle) localToggle.addEventListener("change", updateCoverageGroup);

        // ---- Tag Stack ลุ่มน้ำ / จังหวัด ----
        const basinSelect = item.querySelector(".basin-select");
        const provinceSelect = item.querySelector(".province-select");
        
        setupTagStack(basinSelect, basinTags, basinHidden);
        setupTagStack(provinceSelect, provinceTags, provinceHidden);

        // ---- Search filter ----
        const basinSearch = item.querySelector(".basin-search");
        const provinceSearch = item.querySelector(".province-search");
        setupSearchFilter(basinSelect, basinSearch);
        setupSearchFilter(provinceSelect, provinceSearch);

        // ---- ช่อง "อื่น ๆ" ที่ใช้ checkbox flag คุมการพิมพ์ ----
        function setupOtherWithFlag(itm, flagName, inputName) {
            const flag = itm.querySelector(`input[name="${flagName}"]`);
            const input = itm.querySelector(`input[name="${inputName}"]`);
            if (!flag || !input) return;
            const update = () => {
                const on = flag.checked;
                input.disabled = !on;
                if (!on) input.value = "";
            };
            flag.addEventListener("change", update);
            update();
        }

        setupOtherWithFlag(item, "demMethodOtherFlag[]", "demMethodOther[]");
        setupOtherWithFlag(item, "formatOtherFlag[]", "formatOther[]");
        setupOtherWithFlag(item, "accessOtherFlag[]", "accessOther[]");
        setupOtherWithFlag(item, "qcOtherFlag[]", "qcOther[]");
        setupOtherWithFlag(item, "useOtherFlag[]", "useOther[]");

        // ---- ปุ่มลบ DEM ----
        const removeBtn = item.querySelector(".btn-remove-dem-item");
        if (removeBtn) {
          removeBtn.addEventListener("click", () => {
            item.remove();
            updateDemIndexes();
          });
        }

        // เรียกครั้งแรกเพื่อจัด state เริ่มต้น
        updateCoverageGroup();
      }
    
      // -------------------- Init item แรก --------------------
      const firstItem = demContainer.querySelector(".dem-item");
      attachOtherFieldHandlers(firstItem);
      populateYearSelects();
      updateDemIndexes();
      initReferenceDropdowns();
    
      // -------------------- เพิ่ม DEM item --------------------
      btnAddDemItem.addEventListener("click", () => {
        const first = demContainer.querySelector(".dem-item");
        const clone = first.cloneNode(true);
    
        // ล้างค่าทั้งหมดใน clone
        clone.querySelectorAll("input, textarea, select").forEach((el) => {
          if (el.tagName === "SELECT") {
            el.selectedIndex = 0;
          } else if (el.type === "checkbox" || el.type === "radio") {
            el.checked = false;
            el.disabled = false;
          } else {
            el.value = "";
          }
          if (el.classList.contains("local-input")) {
            el.disabled = true;
          }
        });
    
        // ซ่อน/ปิด other fields (dropdown-อื่นๆ)
        clone
          .querySelectorAll(
            ".source-other-wrapper, .resolution-other-wrapper, .vertical-datum-other-wrapper, .coord-other-wrapper, .license-other-wrapper"
          )
          .forEach((wrap) => wrap.classList.add("hidden"));
    
        clone
          .querySelectorAll(
            ".source-other-input, .resolution-other-input, .vertical-datum-other-input, .coord-other-input, .license-other-input"
          )
          .forEach((inp) => {
            inp.disabled = true;
            inp.value = "";
          });
    
        // ซ่อน block coverage
        clone
          .querySelectorAll(".basin-block, .province-block")
          .forEach((b) => b.classList.add("hidden"));
    
        const cloneLocalBlock = clone.querySelector(".local-block");
        const cloneLocalInput = clone.querySelector(".local-input");
        const cloneLocalToggle = clone.querySelector(".toggle-local");
        if (cloneLocalBlock && cloneLocalInput && cloneLocalToggle) {
          cloneLocalBlock.classList.add("hidden");
          cloneLocalInput.disabled = true;
          cloneLocalInput.value = "";
          cloneLocalToggle.checked = false;
        }
    
        // ล้าง Tag Stack
        clone
          .querySelectorAll(".basin-tags, .province-tags")
          .forEach((c) => (c.innerHTML = ""));
        clone
          .querySelectorAll(".basin-other-input, .province-other-input")
          .forEach((inp) => (inp.value = ""));
    
        // ล้าง search box + unhide ทุก option
        const basinSearch = clone.querySelector(".basin-search");
        const basinSelect = clone.querySelector(".basin-select");
        if (basinSearch) basinSearch.value = "";
        if (basinSelect) {
          Array.from(basinSelect.options).forEach((opt) => (opt.hidden = false));
        }
        const provinceSearch = clone.querySelector(".province-search");
        const provinceSelect = clone.querySelector(".province-select");
        if (provinceSearch) provinceSearch.value = "";
        if (provinceSelect) {
          Array.from(provinceSelect.options).forEach((opt) => (opt.hidden = false));
        }
    
        demContainer.appendChild(clone);
        attachOtherFieldHandlers(clone);
        populateYearSelects();
        updateDemIndexes();
        applyReferenceDataToAllItems();
      });
    
      // -------------------- Reset Form --------------------
      const resetBtn = document.getElementById("btnResetForm");
      resetBtn.addEventListener("click", (e) => {
        e.preventDefault();
        openConfirmModal(
          "ยืนยันล้างข้อมูล",
          "คุณต้องการล้างค่าทั้งหมดในแบบฟอร์มหรือไม่?",
          () => {
            form.reset();
    
            // ลบ DEM item ทั้งหมด ยกเว้นตัวแรก
            const items = demContainer.querySelectorAll(".dem-item");
            items.forEach((item, idx) => {
              if (idx > 0) {
                item.remove();
              }
            });
    
            const first = demContainer.querySelector(".dem-item");
            if (!first) return;
    
            // ล้างสถานะเพิ่มเติมใน item แรก
            const basinBlock = first.querySelector(".basin-block");
            const provinceBlock = first.querySelector(".province-block");
            const basinTags = first.querySelector(".basin-tags");
            const provinceTags = first.querySelector(".province-tags");
            const basinHidden = first.querySelector(".basin-other-input");
            const provinceHidden = first.querySelector(".province-other-input");
            const localInput = first.querySelector(".local-input");
            const localToggle = first.querySelector(".toggle-local");
            const localBlock = first.querySelector(".local-block");
            const basinSearch = first.querySelector(".basin-search");
            const basinSelect = first.querySelector(".basin-select");
            const provinceSearch = first.querySelector(".province-search");
            const provinceSelect = first.querySelector(".province-select");
    
            if (basinBlock) basinBlock.classList.add("hidden");
            if (provinceBlock) provinceBlock.classList.add("hidden");
            if (basinTags) basinTags.innerHTML = "";
            if (provinceTags) provinceTags.innerHTML = "";
            if (basinHidden) basinHidden.value = "";
            if (provinceHidden) provinceHidden.value = "";
    
            if (localBlock) localBlock.classList.add("hidden");
            if (localInput) {
              localInput.value = "";
              localInput.disabled = true;
            }
            if (localToggle) localToggle.checked = false;
    
            if (basinSearch) basinSearch.value = "";
            if (basinSelect) {
              Array.from(basinSelect.options).forEach((opt) => (opt.hidden = false));
            }
            if (provinceSearch) provinceSearch.value = "";
            if (provinceSelect) {
              Array.from(provinceSelect.options).forEach((opt) => (opt.hidden = false));
            }
    
            // รีเซ็ตช่อง other + flag
            attachOtherFieldHandlers(first);
    
            populateYearSelects();
            updateDemIndexes();
            applyReferenceDataToAllItems();
          }
        );
      });
    
      // -------------------- Collect & Submit --------------------
      function getCheckedValues(container, selector, excludeOther) {
        let vals = Array.from(
          container.querySelectorAll(selector + ":checked")
        ).map((el) => el.value);
        if (excludeOther) {
          vals = vals.filter((v) => {
            if (!v) return false;
            const t = v.toString().toLowerCase().replace(/\s+/g, "");
            return t !== "other" && t !== "อื่นๆ" && t !== "อื่นๆระบุ" && t !== "อื่นๆ(ระบุ)";
          });
        }
        return vals;
      }
    
      function collectFormData() {
        const agency = {
          agencyName: document.getElementById("agencyName").value.trim(),
          subUnit: document.getElementById("subUnit").value.trim(),
          contactName: document.getElementById("contactName").value.trim(),
          contactPosition: document
            .getElementById("contactPosition")
            .value.trim(),
          contactPhone: document.getElementById("contactPhone").value.trim(),
          contactEmail: document.getElementById("contactEmail").value.trim(),
        };
    
        const items = [];
        const demItems = demContainer.querySelectorAll(".dem-item");
        demItems.forEach((item) => {
          const itemData = {};
    
          // A. ข้อมูลทั่วไป
          const sourceSelect = item.querySelector('select[name="sourceType[]"]');
          const sourceOtherInput = item.querySelector(
            'input[name="sourceOther[]"]'
          );
    
          itemData.demName =
            item.querySelector('input[name="demName[]"]')?.value.trim() || "";
    
          if (sourceSelect) {
            if (sourceSelect.value === "other") {
              itemData.sourceType =
                (sourceOtherInput?.value || "").trim();
            } else {
              itemData.sourceType = sourceSelect.value || "";
            }
          } else {
            itemData.sourceType = "";
          }
    
          itemData.year =
            item.querySelector('select[name="year[]"]')?.value || "";
    
          // พื้นที่ครอบคลุม
          itemData.coverageCountry = getCheckedValues(
            item,
            'input[name="coverageCountry[]"]',
            false
          );
          itemData.coverageBasinTags =
            item.querySelector(".basin-other-input")?.value.trim() || "";
          itemData.coverageProvinceTags =
            item.querySelector(".province-other-input")?.value.trim() || "";
          itemData.coverageLocal =
            item.querySelector('input[name="coverageLocal[]"]')?.value.trim() ||
            "";
    
          // B. คุณภาพเชิงพื้นที่
          const resSelect = item.querySelector('select[name="resolution[]"]');
          const resOtherInput = item.querySelector(
            'input[name="resolutionOther[]"]'
          );
          if (resSelect) {
            if (
              resSelect.value === "other" ||
              resSelect.value === "lidar_sub1m"
            ) {
              itemData.resolution =
                (resOtherInput?.value || "").trim();
            } else {
              itemData.resolution = resSelect.value || "";
            }
          } else {
            itemData.resolution = "";
          }
    
          itemData.verticalAccuracy =
            item.querySelector('input[name="verticalAccuracy[]"]')?.value || "";
          itemData.horizontalAccuracy =
            item.querySelector('input[name="horizontalAccuracy[]"]')?.value ||
            "";
    
          const vDatumSelect = item.querySelector(
            'select[name="verticalDatum[]"]'
          );
          const vDatumInput = item.querySelector(
            'input[name="verticalDatumOther[]"]'
          );
          if (vDatumSelect) {
            if (vDatumSelect.value === "other") {
              itemData.verticalDatum =
                (vDatumInput?.value || "").trim();
            } else {
              itemData.verticalDatum = vDatumSelect.value || "";
            }
          } else {
            itemData.verticalDatum = "";
          }
    
          const coordSelect = item.querySelector('select[name="coordSys[]"]');
          const coordInput = item.querySelector(
            'input[name="coordSysOther[]"]'
          );
          if (coordSelect) {
            if (coordSelect.value === "other") {
              itemData.coordSys =
                (coordInput?.value || "").trim();
            } else {
              itemData.coordSys = coordSelect.value || "";
            }
          } else {
            itemData.coordSys = "";
          }
    
          // วิธีการจัดทำ DEM
          itemData.demMethods = getCheckedValues(
            item,
            'input[name^="demMethod"]',
            true
          );
          const demMethodOtherText =
            item.querySelector('input[name="demMethodOther[]"]')?.value.trim() ||
            "";
          if (demMethodOtherText) itemData.demMethods.push(demMethodOtherText);
    
          // รูปแบบไฟล์
          itemData.fileFormats = getCheckedValues(
            item,
            'input[name^="format"]',
            true
          );
          const formatOtherText =
            item.querySelector('input[name="formatOther[]"]')?.value.trim() || "";
          if (formatOtherText) itemData.fileFormats.push(formatOtherText);
    
          itemData.fileSize =
            item.querySelector('input[name="fileSize[]"]')?.value || "";
          itemData.fileSizeUnit =
            item.querySelector('select[name="fileSizeUnit[]"]')?.value || "";
    
          // ลิขสิทธิ์
          const licSelect = item.querySelector('select[name="license[]"]');
          const licInput = item.querySelector('input[name="licenseOther[]"]');
          if (licSelect) {
            if (licSelect.value === "other") {
              itemData.license =
                (licInput?.value || "").trim();
            } else {
              itemData.license = licSelect.value || "";
            }
          } else {
            itemData.license = "";
          }
    
          // ช่องทางการเข้าถึง
          itemData.accessChannels = getCheckedValues(
            item,
            'input[name^="access"]',
            true
          );
          itemData.accessOther =
            item.querySelector('input[name="accessOther[]"]')?.value.trim() || "";
    
          // QC/QA
          itemData.qcQa = getCheckedValues(item, 'input[name^="qc"]', true);
          itemData.qcQaOther =
            item.querySelector('input[name="qcOther[]"]')?.value.trim() || "";
    
          // การใช้งาน
          itemData.mainUses = getCheckedValues(
            item,
            'input[name^="use"]',
            true
          );
          itemData.mainUsesOther =
            item.querySelector('input[name="useOther[]"]')?.value.trim() || "";
    
          // หมายเหตุ
          itemData.remark =
            item.querySelector('textarea[name="remark[]"]')?.value.trim() || "";
    
          items.push(itemData);
        });
    
        return { agency, items };
      }

      // ฟังก์ชันแสดง Error ที่ input
      function showError(input, message) {
        // 1. เปลี่ยนเส้นขอบเป็นสีแดง
        input.classList.add("border-red-500", "focus:border-red-500", "focus:ring-red-500");
        input.classList.remove("border-slate-300", "focus:border-blue-500", "focus:ring-blue-500");

        // 2. ตรวจสอบว่ามีข้อความ Error อยู่แล้วไหม ถ้ามีไม่เติมซ้ำ
        const parent = input.parentElement;
        if (!parent.querySelector(".error-text-msg")) {
          const msg = document.createElement("p");
          msg.className = "error-text-msg text-red-500 text-xs mt-1"; // สไตล์ข้อความสีแดง
          msg.textContent = message;
          parent.appendChild(msg);
        }
      }

      // ฟังก์ชันลบ Error เมื่อ user เริ่มกรอกข้อมูล
      function clearError(input) {
        // 1. คืนค่าเส้นขอบเป็นสีปกติ
        input.classList.remove("border-red-500", "focus:border-red-500", "focus:ring-red-500");
        input.classList.add("border-slate-300", "focus:border-blue-500", "focus:ring-blue-500");

        // 2. ลบข้อความ Error ทิ้ง
        const parent = input.parentElement;
        const msg = parent.querySelector(".error-text-msg");
        if (msg) {
          msg.remove();
        }
      }

      // ฟังก์ชันตรวจสอบความถูกต้องทั้งฟอร์ม
      function validateFormCustom() {
        let isValid = true;
        let firstInvalidInput = null;

        // ดึง input, select, textarea ทั้งหมดที่มี attribute 'required'
        // และต้องไม่ disabled (เพราะฟิลด์ที่ซ่อนเราสั่ง disabled ไว้แล้ว)
        const requiredInputs = form.querySelectorAll("[required]:not([disabled])");

        requiredInputs.forEach((input) => {
          // ถ้าค่าว่าง
          if (!input.value.trim()) {
            showError(input, "* จำเป็น (โปรดระบุ)");
            isValid = false;
            if (!firstInvalidInput) firstInvalidInput = input;
            
            // เพิ่ม Event Listener: พิมพ์แล้ว Error หายทันที
            input.addEventListener("input", function() {
                clearError(this);
            }, { once: true }); // ทำงานครั้งเดียวแล้วลบ listener ออกเพื่อไม่ให้ซ้ำซ้อน
            
            // สำหรับ Select box ใช้ event 'change'
            input.addEventListener("change", function() {
                clearError(this);
            }, { once: true });

          } else {
            clearError(input);
          }
        });

        // ถ้ามีช่องผิด ให้เลื่อนหน้าจอไปหาช่องแรกที่ผิด
        if (firstInvalidInput) {
          firstInvalidInput.scrollIntoView({ behavior: "smooth", block: "center" });
          firstInvalidInput.focus();
        }

        return isValid;
      }
      
      async function submitToAppsScript(payload) {
        const resp = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
          body: JSON.stringify(payload),
        });
    
        let data = null;
        try {
          data = await resp.json();
        } catch (e) {
          data = null;
        }
        return data || { success: resp.ok };
      }
    
      form.addEventListener("submit", (e) => {
        e.preventDefault();

        // 1. เรียกใช้ Custom Validation
        if (!validateFormCustom()) {
          return; 
        }

        // 2. ถ้าผ่านแล้ว ค่อยเปิด Modal ยืนยัน
        openConfirmModal(
          "ยืนยันการส่งแบบฟอร์ม",
          "โปรดตรวจสอบข้อมูลให้ถูกต้อง ก่อนยืนยันการส่งแบบฟอร์ม",
          async () => {
            const payload = collectFormData();
            try {
              const res = await submitToAppsScript(payload);

              if (res && res.success) {
                openSuccessModal();
              } else {
                alert("บันทึกข้อมูลไม่สำเร็จ กรุณาลองใหม่อีกครั้ง");
              }

              // 1. Reset Form มาตรฐาน
              form.reset();
              
              // ลบ Error แดงค้างเก่า
              form.querySelectorAll(".error-text-msg").forEach(e => e.remove());
              form.querySelectorAll(".border-red-500").forEach(e => {
                  e.classList.remove("border-red-500");
                  e.classList.add("border-slate-300");
              });

              // ลบ DEM item ส่วนเกิน (ประกาศ items ครั้งเดียวตรงนี้)
              const items = demContainer.querySelectorAll(".dem-item");
              items.forEach((item, idx) => {
                if (idx > 0) item.remove();
              });

              // ===============================================
              // ล้างค่า Stack และซ่อนกล่องที่ค้างอยู่ใน item แรก
              // ===============================================
              const first = demContainer.querySelector(".dem-item");
              if (first) {
                // 1. ล้างป้าย Stack
                const basinTags = first.querySelector(".basin-tags");
                const provinceTags = first.querySelector(".province-tags");
                if (basinTags) basinTags.innerHTML = "";
                if (provinceTags) provinceTags.innerHTML = "";

                // 2. ล้างค่า Hidden Input
                const basinHidden = first.querySelector(".basin-other-input");
                const provinceHidden = first.querySelector(".province-other-input");
                if (basinHidden) basinHidden.value = "";
                if (provinceHidden) provinceHidden.value = "";

                // 3. ซ่อนกล่อง
                const basinBlock = first.querySelector(".basin-block");
                const provinceBlock = first.querySelector(".province-block");
                const localBlock = first.querySelector(".local-block");
                if (basinBlock) basinBlock.classList.add("hidden");
                if (provinceBlock) provinceBlock.classList.add("hidden");
                if (localBlock) localBlock.classList.add("hidden");

                // 4. ล้างค่า "พื้นที่เฉพาะจุด"
                const localInput = first.querySelector(".local-input");
                if (localInput) {
                    localInput.value = "";
                    localInput.disabled = true;
                    localInput.required = false; 
                    clearError(localInput);
                }

                // เรียกฟังก์ชันนี้เพื่อให้ Logic ปุ่มอื่นๆ กลับมาทำงานถูกต้อง
                attachOtherFieldHandlers(first);
              }

              // อัปเดตสถานะต่างๆ ให้พร้อมใช้งานใหม่
              populateYearSelects();
              updateDemIndexes();
              applyReferenceDataToAllItems();

            } catch (err) {
              console.error("submitDemSurvey error", err);
              alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล โปรดลองอีกครั้ง");
            }
          }
        );
      });
    </script>
    
  </body>
</html>
