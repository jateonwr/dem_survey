<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>แบบฟอร์มสำรวจข้อมูล DEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      body { font-family: "Sarabun", system-ui, -apple-system, sans-serif; }
      select[multiple] { min-height: 3.5rem; }

      /* --- UI Components: Toggle Pill --- */
      .toggle-pill {
        position: relative; display: inline-flex; align-items: center; justify-content: center;
        min-width: 54px; height: 22px; border-radius: 9999px; cursor: pointer;
        border: none; outline: none; transition: background-color 0.25s ease; padding: 0;
        background-color: #94a3b8;
      }
      .toggle-pill .toggle-knob {
        width: 16px; height: 16px; border-radius: 50%; background: #ffffff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); position: absolute; top: 3px;
        transition: left 0.25s ease, right 0.25s ease;
      }
      .toggle-label {
        display: inline-block; color: #ffffff; font-size: 10px; font-weight: 600;
        pointer-events: none; transition: margin 0.25s ease;
      }
      .toggle-pill[data-state="shown"] { background-color: #22c55e; }
      .toggle-pill[data-state="shown"] .toggle-knob { left: auto; right: 3px; }
      .toggle-pill[data-state="shown"] .toggle-label { margin-right: 14px; margin-left: 0; }
      
      .toggle-pill[data-state="hidden"] { background-color: #94a3b8; }
      .toggle-pill[data-state="hidden"] .toggle-knob { left: 3px; right: auto; }
      .toggle-pill[data-state="hidden"] .toggle-label { margin-left: 14px; margin-right: 0; }

      /* --- UI Components: Tags --- */
      .tag-pill {
        display: inline-flex; align-items: center; padding: 0.1rem 0.5rem;
        border-radius: 9999px; font-size: 0.75rem; background-color: #dbeafe;
        color: #1d4ed8; cursor: default; margin-right: 0.1rem; position: relative; z-index: 10;
      }
      .tag-pill .tag-text { margin-right: 0.25rem; }
      .tag-pill .tag-remove { font-weight: 600; cursor: pointer; }
    </style>
  </head>
  <body class="min-h-screen bg-slate-100">
    <div class="mx-auto max-w-5xl px-4 py-8 sm:px-6 lg:px-8">
      <div class="rounded-2xl bg-white shadow-lg px-4 py-5 sm:px-6 sm:py-6 lg:px-8">
        
        <header class="border-b border-slate-200 pb-3 mb-5">
          <div class="flex items-center gap-4">
            <img
              src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Emblem_of_the_Office_of_the_National_Water_Resources.svg/1014px-Emblem_of_the_Office_of_the_National_Water_Resources.svg.png"
              alt="สทนช. Emblem"
              class="h-12 w-12 object-contain"
            />
            <div>
              <h1 class="text-xl sm:text-2xl font-semibold text-slate-800">
                แบบฟอร์มสำรวจแบบจำลองความสูงเชิงเลขของหน่วยงานรัฐในประเทศไทย
              </h1>
              <p class="mt-1 text-sm text-slate-600">
                แบบจำลองความสูงเชิงเลข (Digital Elevation Model, DEM)
              </p>
            </div>
          </div>
        </header>

        <form id="demSurveyForm" class="space-y-7" novalidate>
          <section>
            <h2 class="text-lg font-semibold text-slate-800 mb-3 border-l-4 border-blue-600 pl-3">
              ส่วนที่ 1 : ข้อมูลพื้นฐานของหน่วยงาน
            </h2>
            <div class="flex flex-col gap-3 sm:flex-row mb-2">
              <div class="sm:flex-1">
                <label for="agencyName" class="block text-sm font-medium text-slate-700 mb-0.5">ชื่อหน่วยงาน</label>
                <input type="text" id="agencyName" name="agencyName" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น สำนักงานทรัพยากรน้ำแห่งชาติ (สทนช.)" />
              </div>
              <div class="sm:flex-1">
                <label for="subUnit" class="block text-sm font-medium text-slate-700 mb-0.5">หน่วยงานย่อย / สำนัก / กอง</label>
                <input type="text" id="subUnit" name="subUnit" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น กองวิจัยและพัฒนา" />
              </div>
            </div>
            <fieldset class="border border-slate-300 rounded-lg p-3 bg-slate-50/30">
              <legend class="px-2 text-sm font-semibold text-slate-700">ผู้ประสานงาน</legend>
              <div class="grid gap-3 sm:grid-cols-2">
                <div>
                  <label for="contactName" class="block text-sm font-medium text-slate-700">(คำนำหน้า) ชื่อ – สกุล</label>
                  <input type="text" id="contactName" name="contactName" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น นายสมชาย ใจดี" />
                </div>
                <div>
                  <label for="contactPosition" class="block text-sm font-medium text-slate-700">ตำแหน่ง</label>
                  <input type="text" id="contactPosition" name="contactPosition" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น วิศวกร" />
                </div>
                <div>
                  <label for="contactPhone" class="block text-sm font-medium text-slate-700">เบอร์โทรศัพท์</label>
                  <input type="tel" id="contactPhone" name="contactPhone" inputmode="numeric" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น xx-xxx-xxxx หรือ xxx-xxx-xxxx" />
                </div>
                <div>
                  <label for="contactEmail" class="block text-sm font-medium text-slate-700">อีเมล</label>
                  <input type="email" id="contactEmail" name="contactEmail" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น email@example.go.th" />
                </div>
              </div>
            </fieldset>
          </section>

          <hr class="border-slate-200" />

          <section>
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-4">
              <div>
                <h2 class="text-lg font-semibold text-slate-800 border-l-4 border-blue-600 pl-3">
                  ส่วนที่ 2 : รายการข้อมูล DEM ที่หน่วยงานมี
                </h2>
              </div>
              <button type="button" id="btnAddDemItem" class="inline-flex items-center justify-center rounded-lg border border-blue-600 bg-blue-600 px-2.5 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-blue-700 active:bg-blue-800 transition-colors gap-2">
                <i class="fa-solid fa-file-circle-plus"></i><span>เพิ่มชุดข้อมูล</span>
              </button>
            </div>

            <div id="demItemsContainer" class="space-y-5">
              <div class="dem-item rounded-xl border border-slate-300 bg-slate-50 px-3 py-4 sm:px-4 sm:py-4 relative">
                <div class="flex items-center justify-between gap-2 mb-3 border-b border-slate-200 pb-2">
                  <h3 class="text-sm font-bold text-slate-700 flex items-center gap-2">
                    ชุดข้อมูลที่ 1
                    <button type="button" class="btn-remove-dem-item inline-flex items-center justify-center rounded-md border border-rose-300 bg-white px-1 py-0.5 text-xm font-medium text-rose-600 hover:bg-rose-500 hover:text-white transition shadow-sm hidden" title="ลบชุดข้อมูลนี้">
                      <i class="fa-solid fa-xmark mr-1"> </i><span class="mr-1">ลบชุดข้อมูล</span>
                    </button>
                  </h3>
                  <div class="flex items-center gap-2">
                    <span class="text-[11px] text-slate-500 hidden sm:inline">ทั้งหมด</span>
                    <button type="button" class="item-toggle-all toggle-pill" data-state="hidden">
                      <span class="toggle-knob"></span><span class="toggle-label">แสดง</span>
                    </button>
                  </div>
                </div>

                <div class="space-y-4">
                  <div class="section-card rounded-lg bg-white border border-slate-200 px-3 py-3 space-y-3 shadow-sm">
                    <div class="section-header flex items-center justify-between select-none">
                      <p class="text-sm font-semibold text-slate-800">A. ข้อมูลทั่วไป</p>
                      <button type="button" class="section-toggle toggle-pill" data-state="shown">
                        <span class="toggle-knob"></span><span class="toggle-label">ซ่อน</span>
                      </button>
                    </div>
                    <div class="section-body space-y-3">
                      <div class="flex flex-col gap-3 sm:flex-row sm:items-start">
                        <div class="sm:flex-1">
                          <label class="block text-sm font-medium text-slate-700 mb-1">1. ชื่อชุดข้อมูล DEM</label>
                          <input type="text" name="demName[]" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น LiDAR พ.ศ. 2566 พื้นที่ลุ่มน้ำบางปะกง หรือชื่อโครงการจัดทำ DEM" />
                        </div>
                        <div class="sm:basis-[30%]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">2. แหล่งที่มา/ผู้ผลิตข้อมูล</label>
                          <select name="sourceType[]" class="source-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- เลือกแหล่งที่มา --</option><option value="self">หน่วยงานผลิตเอง</option><option value="rtsd">กรมแผนที่ทหาร</option><option value="gistda">GISTDA</option><option value="ldd">กรมพัฒนาที่ดิน</option><option value="other">อื่น ๆ (ระบุ)</option>
                          </select>
                          <div class="source-other-wrapper mt-2 hidden">
                            <input type="text" name="sourceOther[]" class="source-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุหน่วยงาน / บริษัท" disabled />
                          </div>
                        </div>
                        <div class="sm:basis-[10%] sm:max-w-[96px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">3. ปีจัดทำ</label>
                          <select name="year[]" class="year-select block w-full rounded-md border border-slate-300 bg-white px-2 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">พ.ศ.</option>
                          </select>
                        </div>
                      </div>

                      <div>
                        <p class="block text-sm font-medium text-slate-700 mb-1">4. พื้นที่ครอบคลุม</p>
                        <div class="space-y-1 text-sm">
                          <label class="inline-flex items-center gap-2">
                            <input type="checkbox" name="coverageCountry[]" value="thailand_all" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500" />
                            <span>ประเทศไทยทั้งหมด</span>
                          </label>
                          <div class="space-y-1">
                            <div class="inline-flex flex-wrap items-center gap-2">
                              <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="toggle-basin h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500" />
                                <span>ลุ่มน้ำ (สามารถระบุได้หลายค่า)</span>
                              </label>
                              <div class="basin-tags flex flex-wrap items-center gap-1"></div>
                            </div>
                            <div class="basin-block mt-1 hidden">
                              <input type="text" class="basin-search mb-1 block w-full rounded-md border border-slate-300 bg-white px-3 py-1 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="พิมพ์เพื่อค้นหาลุ่มน้ำ" />
                              <select name="coverageBasin[]" multiple class="basin-select block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                              <p class="mt-1 text-xm text-slate-500">* Double Click เพื่อเพิ่ม/ลบ ลุ่มน้ำ</p>
                              <input type="hidden" name="coverageBasinOther[]" class="basin-other-input" />
                            </div>
                          </div>
                          <div class="space-y-1">
                            <div class="inline-flex flex-wrap items-center gap-2">
                              <label class="inline-flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="toggle-province h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500" />
                                <span>จังหวัด (สามารถระบุได้หลายค่า)</span>
                              </label>
                              <div class="province-tags flex flex-wrap items-center gap-1"></div>
                            </div>
                            <div class="province-block mt-1 hidden">
                              <input type="text" class="province-search mb-1 block w-full rounded-md border border-slate-300 bg-white px-3 py-1 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="พิมพ์เพื่อค้นหาจังหวัด" />
                              <select name="coverageProvince[]" multiple class="province-select block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                              <p class="mt-1 text-xm text-slate-500">* Double Click เพื่อเพิ่ม/ลบ จังหวัด</p>
                              <input type="hidden" name="coverageProvinceOther[]" class="province-other-input" />
                            </div>
                          </div>
                          <div class="space-y-1">
                            <label class="inline-flex items-center gap-2">
                              <input type="checkbox" class="toggle-local h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500" />
                              <span>พื้นที่เฉพาะจุด</span>
                            </label>
                            <div class="local-block mt-1 hidden">
                              <input type="text" name="coverageLocal[]" class="local-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:cursor-not-allowed" placeholder="เช่น เขตเทศบาลเมืองหาดใหญ่" disabled />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="section-card rounded-lg bg-white border border-slate-200 px-3 py-3 space-y-3 shadow-sm">
                    <div class="section-header flex items-center justify-between select-none">
                      <p class="text-sm font-semibold text-slate-800">B. รายละเอียดทางเทคนิค</p>
                      <button type="button" class="section-toggle toggle-pill" data-state="hidden"><span class="toggle-knob"></span><span class="toggle-label">แสดง</span></button>
                    </div>
                    <div class="section-body space-y-3 hidden">
                      <div class="flex flex-col gap-3 lg:flex-row lg:items-start lg:flex-nowrap">
                        <div class="lg:flex-1 min-w-[160px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">5. Resolution</label>
                          <select name="resolution[]" class="resolution-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- เลือก Resolution --</option><option value="30m">30 m</option><option value="10m">10 m</option><option value="5m">5 m</option><option value="1m">1 m</option><option value="lidar_sub1m">ต่ำกว่า 1 m (LiDAR / ระบุ)</option><option value="other">อื่น ๆ (ระบุ)</option>
                          </select>
                          <div class="resolution-other-wrapper mt-2 hidden">
                            <input type="text" name="resolutionOther[]" class="resolution-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น 0.5 m หรือรายละเอียดเพิ่มเติม" disabled />
                          </div>
                        </div>
                        <div class="lg:flex-1 min-w-[140px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">6. Vertical Accuracy (ม.)</label>
                          <input type="text" name="verticalAccuracy[]" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น 0.15" />
                        </div>
                        <div class="lg:flex-1 min-w-[140px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">7. Horizontal Accuracy (ม.)</label>
                          <input type="text" name="horizontalAccuracy[]" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น 0.30" />
                        </div>
                      </div>
                      <div class="flex flex-col gap-3 lg:flex-row lg:items-start lg:flex-nowrap">
                        <div class="lg:basis-1/2 min-w-[160px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">8. Vertical Datum</label>
                          <select name="verticalDatum[]" class="vertical-datum-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- เลือก Vertical Datum --</option><option value="MSL">MSL</option><option value="EGM96">EGM96</option><option value="other">อื่น ๆ (ระบุ)</option>
                          </select>
                          <div class="vertical-datum-other-wrapper mt-2 hidden">
                            <input type="text" name="verticalDatumOther[]" class="vertical-datum-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุ Datum อื่น ๆ" disabled />
                          </div>
                        </div>
                        <div class="lg:basis-1/2 min-w-[160px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">9. Coordinate System</label>
                          <select name="coordSys[]" class="coord-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- เลือก Coordinate System --</option><option value="WGS84">WGS84</option><option value="UTM47N">UTM 47N</option><option value="UTM48N">UTM 48N</option><option value="other">อื่น ๆ (ระบุ)</option>
                          </select>
                          <div class="coord-other-wrapper mt-2 hidden">
                            <input type="text" name="coordSysOther[]" class="coord-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุระบบพิกัดอื่น ๆ" disabled />
                          </div>
                        </div>
                      </div>
                      <fieldset class="border border-slate-200 rounded-lg px-3 py-3">
                        <legend class="block text-sm font-medium text-slate-700">10. วิธีการจัดทำ DEM (สามารถระบุได้หลายค่า)</legend>
                        <div class="flex flex-wrap gap-3 text-sm">
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="demMethodLidar[]" value="LiDAR" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>LiDAR</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="demMethodUav[]" value="UAV Photogrammetry" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>UAV Photogrammetry</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="demMethodAlos[]" value="ALOS" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>ALOS</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="demMethodSrtm[]" value="SRTM" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>SRTM</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="demMethodTanDEM[]" value="TanDEM-X" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>TanDEM-X</span></label>
                          <label class="inline-flex items-center gap-2 flex-1 min-w-[220px]">
                            <input type="checkbox" name="demMethodOtherFlag[]" value="other" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>อื่น ๆ</span>
                            <input type="text" name="demMethodOther[]" class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุวิธีการจัดทำ DEM">
                          </label>
                        </div>
                      </fieldset>
                    </div>
                  </div>

                  <div class="section-card rounded-lg bg-white border border-slate-200 px-3 py-3 space-y-3 shadow-sm">
                    <div class="section-header flex items-center justify-between select-none">
                      <p class="text-sm font-semibold text-slate-800">C. รูปแบบไฟล์และการเข้าถึง</p>
                      <button type="button" class="section-toggle toggle-pill" data-state="hidden"><span class="toggle-knob"></span><span class="toggle-label">แสดง</span></button>
                    </div>
                    <div class="section-body space-y-3 hidden">
                      <fieldset class="border border-slate-200 rounded-lg px-3 py-3">
                        <legend class="block text-sm font-medium text-slate-700">11. File Format (สามารถระบุได้หลายค่า)</legend>
                        <div class="flex flex-wrap gap-3 text-sm">
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="formatGeoTIFF[]" value="GeoTIFF" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>GeoTIFF</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="formatIMG[]" value="IMG" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>IMG</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="formatASC[]" value="ASC" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>ASC</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="formatLAS[]" value="LAS/LAZ" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>LAS/LAZ</span></label>
                          <label class="inline-flex items-center gap-2 flex-1 min-w-[220px]">
                            <input type="checkbox" name="formatOtherFlag[]" value="other" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>อื่น ๆ</span>
                            <input type="text" name="formatOther[]" class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุรูปแบบไฟล์อื่น ๆ">
                          </label>
                        </div>
                      </fieldset>
                      <div class="flex flex-col gap-3 md:flex-row md:items-start md:flex-wrap">
                        <div class="md:flex-1 md:min-w-[220px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">12. ขนาดไฟล์</label>
                          <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                            <div class="w-full sm:w-1/2">
                              <input type="text" name="fileSize[]" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="เช่น 120" />
                            </div>
                            <div class="w-full sm:w-1/2">
                              <select name="fileSizeUnit[]" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-- หน่วย --</option><option value="TB">TB</option><option value="GB">GB</option><option value="MB">MB</option><option value="KB">KB</option>
                              </select>
                            </div>
                          </div>
                        </div>
                        <div class="md:flex-1 md:min-w-[220px]">
                          <label class="block text-sm font-medium text-slate-700 mb-1">13. ลิขสิทธิ์</label>
                          <select name="license[]" class="license-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- เลือกลิขสิทธิ์ --</option><option value="open">Open Data</option><option value="internal">Internal</option><option value="exchange">Exchange</option><option value="restricted">Security Restricted</option><option value="other">อื่น ๆ (ระบุ)</option>
                          </select>
                          <div class="license-other-wrapper mt-2 hidden">
                            <input type="text" name="licenseOther[]" class="license-other-input block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุประเภทลิขสิทธิ์อื่น ๆ" disabled />
                          </div>
                        </div>
                      </div>
                      <fieldset class="border border-slate-200 rounded-lg px-3 py-3">
                        <legend class="block text-sm font-medium text-slate-700">14. ช่องทางการเข้าถึง (สามารถระบุได้หลายค่า)</legend>
                        <div class="flex flex-wrap gap-3 text-sm">
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="accessWeb[]" value="web" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>เว็บดาวน์โหลด</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="accessOfficial[]" value="official_letter" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>หนังสือราชการ</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="accessMou[]" value="mou_nda" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>MOU / NDA</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="accessInternal[]" value="internal" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>ภายในหน่วยงาน</span></label>
                          <label class="inline-flex items-center gap-2 flex-1 min-w-[220px]">
                            <input type="checkbox" name="accessOtherFlag[]" value="other" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>อื่น ๆ</span>
                            <input type="text" name="accessOther[]" class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุช่องทางอื่น ๆ">
                          </label>
                        </div>
                      </fieldset>
                    </div>
                  </div>

                  <div class="section-card rounded-lg bg-white border border-slate-200 px-3 py-3 space-y-3 shadow-sm">
                    <div class="section-header flex items-center justify-between select-none">
                      <p class="text-sm font-semibold text-slate-800">D. คุณภาพและการใช้งาน</p>
                      <button type="button" class="section-toggle toggle-pill" data-state="hidden"><span class="toggle-knob"></span><span class="toggle-label">แสดง</span></button>
                    </div>
                    <div class="section-body space-y-3 hidden">
                      <fieldset class="border border-slate-200 rounded-lg px-3 py-3">
                        <legend class="block text-sm font-medium text-slate-700">15. QC/QA (สามารถระบุได้หลายค่า)</legend>
                        <div class="flex flex-wrap gap-3 text-sm">
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="qcNone[]" value="none" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>ไม่มี</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="qcGcp[]" value="GCP" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>GCP</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="qcOtherDEM[]" value="compare_dem" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>เปรียบเทียบ DEM อื่น</span></label>
                          <label class="inline-flex items-center gap-2 flex-1 min-w-[220px]">
                            <input type="checkbox" name="qcOtherFlag[]" value="other" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>อื่น ๆ</span>
                            <input type="text" name="qcOther[]" class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุวิธี QC/QA อื่น ๆ">
                          </label>
                        </div>
                      </fieldset>
                      <fieldset class="border border-slate-200 rounded-lg px-3 py-3">
                        <legend class="block text-sm font-medium text-slate-700">16. การใช้งานหลัก (สามารถระบุได้หลายค่า)</legend>
                        <div class="flex flex-wrap gap-3 text-sm">
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="useFlood[]" value="flood" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>น้ำท่วม</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="useSubBasin[]" value="sub_basin" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>ลุ่มน้ำย่อย</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="useUrbanPlan[]" value="urban_planning" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>ผังเมือง</span></label>
                          <label class="inline-flex items-center gap-2"><input type="checkbox" name="useModel[]" value="models" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>แบบจำลอง RRI / HEC / MIKE</span></label>
                          <label class="inline-flex items-center gap-2 flex-1 min-w-[220px]">
                            <input type="checkbox" name="useOtherFlag[]" value="other" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500"><span>อื่น ๆ</span>
                            <input type="text" name="useOther[]" class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุการใช้งานอื่น ๆ">
                          </label>
                        </div>
                      </fieldset>
                      <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">17. หมายเหตุ</label>
                        <textarea name="remark[]" rows="1" style="resize: vertical; min-height: 2.5rem;" class="block w-full rounded-md border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุหมายเหตุเพิ่มเติม เช่น ปัญหาในการใช้งาน, ข้อจำกัด, แผนการปรับปรุงในอนาคต"></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <div class="flex flex-col gap-3 pt-4 border-t border-slate-200 sm:flex-row sm:items-center sm:justify-end">
            <button type="reset" id="btnResetForm" class="inline-flex items-center justify-center rounded-lg border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-50 active:bg-slate-100">ล้างค่า</button>
            <button type="submit" id="btnSubmitForm" class="inline-flex items-center justify-center rounded-lg border border-blue-600 bg-blue-600 px-5 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 active:bg-blue-800">บันทึกแบบฟอร์ม</button>
          </div>
        </form>
      </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-gray-900/60 transition-opacity">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-[400px] mx-4 p-6 transform transition-all">
        <h3 id="confirmTitle" class="text-xl font-bold text-gray-900 mb-2 text-left">ยืนยันล้างข้อมูล</h3>
        <p id="confirmMessage" class="text-base text-gray-600 mb-8 text-left leading-relaxed">คุณต้องการล้างค่าทั้งหมดในแบบฟอร์มหรือไม่?</p>
        <div class="flex justify-end gap-3">
          <button type="button" id="confirmCancel" class="px-5 py-2.5 rounded-lg border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 transition-colors">ยกเลิก</button>
          <button type="button" id="confirmOk" class="px-5 py-2.5 rounded-lg bg-blue-600 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm transition-colors">ยืนยัน</button>
        </div>
      </div>
    </div>

    <div id="successModal" class="fixed inset-0 z-[60] hidden items-center justify-center" aria-labelledby="modal-title" role="dialog" aria-modal="true">
      <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"></div>
      <div class="relative z-10 w-full max-w-sm transform overflow-hidden rounded-2xl bg-white p-6 text-center shadow-2xl transition-all sm:p-8 scale-100">
        <div class="mx-auto mb-5 flex h-16 w-16 items-center justify-center rounded-full bg-green-100">
          <i class="fa-solid fa-check text-3xl text-green-600"></i>
        </div>
        <h3 class="mb-2 text-xl font-bold text-slate-800" id="modal-title">บันทึกข้อมูลสำเร็จ!</h3>
        <p class="mb-6 text-sm text-slate-500">ระบบได้ทำการบันทึกข้อมูลแบบฟอร์มเสร็จสิ้น</p>
        <button type="button" id="successOk" class="inline-flex w-full justify-center rounded-xl bg-green-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-green-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-600 transition-all duration-200">ตกลง</button>
      </div>
    </div>

    <script>
      /**
       * DEM Survey Form Script - Professional & Optimized Version
       */
      (function() {
        // --- CONSTANTS & CONFIGURATION ---
        const CONFIG = {
          API_URL: "https://script.google.com/macros/s/AKfycbw8Wf9vZsQbksaG7dmtWxw2b26xzCxI0Rl1lTlWggIS_rlULBL-wkOjDgRBZuH_vWI5Lw/exec",
          REQUIRED_AGENCY_IDS: ["agencyName", "subUnit", "contactName", "contactPosition", "contactPhone", "contactEmail"],
          YEAR_START: 2539,
          YEAR_END: 2568,
          // Mapping for fields that have an "Other" toggle option
          TOGGLE_FIELDS: [
            { trigger: '.source-select', wrapper: '.source-other-wrapper', input: '.source-other-input', type: 'select', value: 'other' },
            { trigger: '.resolution-select', wrapper: '.resolution-other-wrapper', input: '.resolution-other-input', type: 'select', checkFn: val => val === 'lidar_sub1m' || val === 'other' },
            { trigger: '.vertical-datum-select', wrapper: '.vertical-datum-other-wrapper', input: '.vertical-datum-other-input', type: 'select', value: 'other' },
            { trigger: '.coord-select', wrapper: '.coord-other-wrapper', input: '.coord-other-input', type: 'select', value: 'other' },
            { trigger: '.license-select', wrapper: '.license-other-wrapper', input: '.license-other-input', type: 'select', value: 'other' },
            { trigger: 'input[name="demMethodOtherFlag[]"]', input: 'input[name="demMethodOther[]"]', type: 'checkbox' },
            { trigger: 'input[name="formatOtherFlag[]"]', input: 'input[name="formatOther[]"]', type: 'checkbox' },
            { trigger: 'input[name="accessOtherFlag[]"]', input: 'input[name="accessOther[]"]', type: 'checkbox' },
            { trigger: 'input[name="qcOtherFlag[]"]', input: 'input[name="qcOther[]"]', type: 'checkbox' },
            { trigger: 'input[name="useOtherFlag[]"]', input: 'input[name="useOther[]"]', type: 'checkbox' }
          ]
        };

        // --- DOM ELEMENTS ---
        const els = {
          container: document.getElementById("demItemsContainer"),
          addBtn: document.getElementById("btnAddDemItem"),
          form: document.getElementById("demSurveyForm"),
          resetBtn: document.getElementById("btnResetForm"),
          contactPhone: document.getElementById("contactPhone"),
          modals: {
            confirm: { el: document.getElementById("confirmModal"), title: document.getElementById("confirmTitle"), msg: document.getElementById("confirmMessage"), ok: document.getElementById("confirmOk"), cancel: document.getElementById("confirmCancel") },
            success: { el: document.getElementById("successModal"), ok: document.getElementById("successOk") }
          }
        };

        let refData = null;
        let confirmCallback = null;

        // --- UTILITIES ---
        const Utils = {
          // Setup numeric/phone input handling
          setupNumeric: (input, type = 'decimal') => {
            if (!input) return;
            input.setAttribute("inputmode", type === 'decimal' ? "decimal" : "numeric");
            const handler = function(e) {
              let val = this.value;
              if (type === 'decimal') {
                val = val.replace(/[^0-9.]/g, "");
                const parts = val.split('.');
                if (parts.length > 2) val = parts[0] + '.' + parts.slice(1).join('');
              } else {
                val = val.replace(/\D/g, "");
              }
              this.value = val;
              if(e.type === 'input') {
                Utils.clearError(this);
                if (type === 'phone' && val.length > 0 && (val.length < 9 || val.length > 10)) this.setCustomValidity("กรุณากรอก 9-10 หลัก");
                else this.setCustomValidity("");
              }
            };
            input.addEventListener("input", handler);
            input.addEventListener("focus", function() { if(type === 'phone') this.value = this.value.replace(/\D/g, ""); });
            input.addEventListener("blur", function() {
              if (type === 'phone') {
                let d = this.value.replace(/\D/g, "");
                if (d.length === 9) this.value = d.replace(/^(\d{2})(\d{3})(\d{4})$/, "$1-$2-$3");
                else if (d.length === 10) this.value = d.replace(/^(\d{3})(\d{3})(\d{4})$/, "$1-$2-$3");
              }
            });
          },
          showError: (input, msgText) => {
            input.classList.add("border-red-500", "focus:border-red-500", "focus:ring-red-500");
            input.classList.remove("border-slate-300", "focus:border-blue-500", "focus:ring-blue-500");
            const p = input.parentElement;
            if (!p.querySelector(".error-text-msg")) {
              const m = document.createElement("p");
              m.className = "error-text-msg text-red-500 text-xs mt-1";
              m.textContent = msgText;
              p.appendChild(m);
            }
          },
          clearError: (input) => {
            input.classList.remove("border-red-500", "focus:border-red-500", "focus:ring-red-500");
            input.classList.add("border-slate-300", "focus:border-blue-500", "focus:ring-blue-500");
            const m = input.parentElement.querySelector(".error-text-msg");
            if (m) m.remove();
          },
          getCheckedValues: (container, selector, excludeOther = false) => {
            let vals = Array.from(container.querySelectorAll(selector + ":checked")).map(el => el.value);
            if (excludeOther) {
              vals = vals.filter(v => {
                if (!v) return false;
                const t = v.toString().toLowerCase().replace(/\s+/g, "");
                return !['other', 'อื่นๆ', 'อื่นๆระบุ', 'อื่นๆ(ระบุ)'].includes(t);
              });
            }
            return vals;
          },
          populateSelect: (selectEl, values) => {
            if (!selectEl) return;
            const selected = Array.from(selectEl.options).filter(o => o.selected).map(o => o.value);
            selectEl.innerHTML = "";
            (values || []).forEach(val => {
              const opt = document.createElement("option");
              opt.value = val; opt.textContent = val;
              if (selected.includes(val)) opt.selected = true;
              selectEl.appendChild(opt);
            });
          }
        };

        // --- MODAL HANDLING ---
        const Modals = {
          openConfirm: (title, message, callback) => {
            els.modals.confirm.title.textContent = title;
            els.modals.confirm.msg.textContent = message;
            confirmCallback = callback;
            els.modals.confirm.el.classList.remove("hidden");
            els.modals.confirm.el.classList.add("flex");
          },
          closeConfirm: () => {
            els.modals.confirm.el.classList.add("hidden");
            els.modals.confirm.el.classList.remove("flex");
            confirmCallback = null;
          },
          openSuccess: () => {
            els.modals.success.el.classList.remove("hidden");
            els.modals.success.el.classList.add("flex");
            els.modals.success.ok.focus();
          },
          closeSuccess: () => {
            els.modals.success.el.classList.add("hidden");
            els.modals.success.el.classList.remove("flex");
          }
        };

        // Event Listeners for Modals
        els.modals.confirm.cancel.addEventListener("click", Modals.closeConfirm);
        els.modals.confirm.ok.addEventListener("click", () => { if (confirmCallback) confirmCallback(); Modals.closeConfirm(); });
        els.modals.confirm.el.addEventListener("click", e => { if (e.target === els.modals.confirm.el) Modals.closeConfirm(); });
        els.modals.success.ok.addEventListener("click", Modals.closeSuccess);
        els.modals.success.el.addEventListener("click", e => { if (e.target === els.modals.success.el) Modals.closeSuccess(); });
        document.addEventListener("keydown", e => { if (e.key === "Escape") { Modals.closeConfirm(); Modals.closeSuccess(); } });

        // --- CORE LOGIC ---
        
        async function init() {
          // Setup Contact Phone
          Utils.setupNumeric(els.contactPhone, 'phone');
          
          // Setup Required Agency Fields
          CONFIG.REQUIRED_AGENCY_IDS.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.required = true;
          });

          // Init first item
          const firstItem = els.container.querySelector(".dem-item");
          FormHandler.attachEvents(firstItem);
          FormHandler.populateYears();
          FormHandler.updateIndexes();
          
          // Load Reference Data
          try {
            const resp = await fetch(CONFIG.API_URL + "?action=getReferenceData");
            refData = await resp.json() || { basins: [], provinces: [] };
            FormHandler.applyRefData();
          } catch (err) { console.error("RefData Error", err); }
        }

        const FormHandler = {
          attachEvents: (item) => {
            if (!item) return;
            
            // 1. Toggles (Section visibility)
            FormHandler.setupSectionToggles(item);
            
            // 2. Required Fields in Item
            const reqs = ['input[name="demName[]"]', 'select[name="sourceType[]"]', 'select[name="year[]"]'];
            reqs.forEach(sel => { const el = item.querySelector(sel); if(el) el.required = true; });

            // 3. Numeric Fields
            ['verticalAccuracy[]', 'horizontalAccuracy[]', 'fileSize[]'].forEach(name => {
              Utils.setupNumeric(item.querySelector(`input[name="${name}"]`), 'decimal');
            });

            // 4. "Other" Fields Logic (Optimized Loop)
            CONFIG.TOGGLE_FIELDS.forEach(conf => {
              const trigger = item.querySelector(conf.trigger);
              const input = item.querySelector(conf.input);
              const wrapper = conf.wrapper ? item.querySelector(conf.wrapper) : null;
              
              if (!trigger || !input) return;

              const handler = () => {
                let show = false;
                if (conf.type === 'select') {
                  const val = trigger.value;
                  show = conf.checkFn ? conf.checkFn(val) : (val === conf.value);
                } else { // checkbox
                  show = trigger.checked;
                }
                
                if (wrapper) wrapper.classList.toggle("hidden", !show);
                input.disabled = !show;
                if (!show) {
                   input.value = "";
                   Utils.clearError(input);
                } else {
                   // Optional: input.focus();
                }
              };
              trigger.addEventListener("change", handler);
              handler(); // Init state
            });

            // 5. Coverage Logic (Complex interaction)
            FormHandler.setupCoverageLogic(item);

            // 6. Search Filters for Basin/Province
            ['basin', 'province'].forEach(type => {
               const search = item.querySelector(`.${type}-search`);
               const select = item.querySelector(`.${type}-select`);
               if(search && select) {
                 search.addEventListener("input", () => {
                   const term = search.value.trim().toLowerCase();
                   Array.from(select.options).forEach((opt, i) => {
                     if (i===0 && opt.value === "") { opt.hidden = false; return; } // placeholder
                     opt.hidden = term ? !opt.textContent.toLowerCase().includes(term) : false;
                   });
                 });
               }
            });

            // 7. Remove Button
            const rmBtn = item.querySelector(".btn-remove-dem-item");
            if (rmBtn) rmBtn.addEventListener("click", () => { item.remove(); FormHandler.updateIndexes(); });
          },

          setupSectionToggles: (item) => {
            const cards = item.querySelectorAll(".section-card");
            const toggleBtn = (card, show) => {
               const body = card.querySelector(".section-body");
               const btn = card.querySelector(".section-toggle");
               if(!body || !btn) return;
               body.classList.toggle("hidden", !show);
               btn.dataset.state = show ? "shown" : "hidden";
               btn.querySelector(".toggle-label").textContent = show ? "ซ่อน" : "แสดง";
            };
            
            // Init: Show A, Hide others
            cards.forEach((c, i) => toggleBtn(c, i === 0));
            cards.forEach(c => c.querySelector(".section-toggle")?.addEventListener("click", () => {
               toggleBtn(c, c.querySelector(".section-body").classList.contains("hidden"));
               updateMasterToggle();
            }));

            const master = item.querySelector(".item-toggle-all");
            const updateMasterToggle = () => {
               if(!master) return;
               const hidden = Array.from(cards).some(c => c.querySelector(".section-body").classList.contains("hidden"));
               master.dataset.state = hidden ? "hidden" : "shown";
               master.querySelector(".toggle-label").textContent = hidden ? "แสดง" : "ซ่อน";
            };
            if(master) master.addEventListener("click", () => {
               const show = master.dataset.state === "hidden";
               cards.forEach(c => toggleBtn(c, show));
               updateMasterToggle();
            });
          },

          setupCoverageLogic: (item) => {
             const els = {
               country: item.querySelector('input[name="coverageCountry[]"]'),
               basinToggle: item.querySelector(".toggle-basin"),
               provToggle: item.querySelector(".toggle-province"),
               localToggle: item.querySelector(".toggle-local"),
               basinBlock: item.querySelector(".basin-block"),
               provBlock: item.querySelector(".province-block"),
               localBlock: item.querySelector(".local-block"),
               localInput: item.querySelector(".local-input"),
               basinTags: item.querySelector(".basin-tags"),
               provTags: item.querySelector(".province-tags"),
               basinHidden: item.querySelector(".basin-other-input"),
               provHidden: item.querySelector(".province-other-input"),
               basinSelect: item.querySelector(".basin-select"),
               provSelect: item.querySelector(".province-select")
             };

             // Tag Stack Logic
             const setupTags = (select, container, hidden) => {
                if(!select) return;
                const update = (vals) => {
                   container.innerHTML = vals.map(v => `<span class="tag-pill" data-val="${v}"><span class="tag-text">${v}</span><span class="tag-remove">×</span></span>`).join('');
                   hidden.value = vals.join(", ");
                };
                select.addEventListener("dblclick", () => {
                   const val = select.value;
                   if(!val) return;
                   let curr = hidden.value ? hidden.value.split(", ") : [];
                   if(curr.includes(val)) curr = curr.filter(x => x !== val);
                   else curr.push(val);
                   update(curr);
                });
                container.addEventListener("click", e => {
                   const btn = e.target.closest(".tag-remove");
                   if(!btn) return;
                   const val = btn.closest(".tag-pill").dataset.val;
                   update(hidden.value.split(", ").filter(x => x !== val));
                });
             };
             setupTags(els.basinSelect, els.basinTags, els.basinHidden);
             setupTags(els.provSelect, els.provTags, els.provHidden);

             const updateState = () => {
                const isCountry = els.country && els.country.checked;
                if (isCountry) {
                   [els.basinToggle, els.provToggle, els.localToggle].forEach(el => { if(el) { el.checked = false; el.disabled = true; }});
                   [els.basinBlock, els.provBlock, els.localBlock].forEach(el => el && el.classList.add("hidden"));
                   if(els.basinTags) els.basinTags.innerHTML = "";
                   if(els.provTags) els.provTags.innerHTML = "";
                   if(els.basinHidden) els.basinHidden.value = "";
                   if(els.provHidden) els.provHidden.value = "";
                   if(els.localInput) { els.localInput.value = ""; els.localInput.disabled = true; Utils.clearError(els.localInput); }
                } else {
                   [els.basinToggle, els.provToggle, els.localToggle].forEach(el => { if(el) el.disabled = false; });
                   if(els.basinBlock) els.basinBlock.classList.toggle("hidden", !els.basinToggle.checked);
                   if(els.provBlock) els.provBlock.classList.toggle("hidden", !els.provToggle.checked);
                   const showLocal = els.localToggle.checked;
                   if(els.localBlock) els.localBlock.classList.toggle("hidden", !showLocal);
                   if(els.localInput) { 
                      els.localInput.disabled = !showLocal; 
                      if(!showLocal) { els.localInput.value = ""; Utils.clearError(els.localInput); }
                   }
                }
             };

             [els.country, els.basinToggle, els.provToggle, els.localToggle].forEach(el => el && el.addEventListener("change", updateState));
             updateState(); // Init
          },

          populateYears: () => {
            const selects = document.querySelectorAll(".year-select");
            selects.forEach(sel => {
              if (sel.options.length > 1) return;
              for (let y = CONFIG.YEAR_END; y >= CONFIG.YEAR_START; y--) {
                const opt = document.createElement("option");
                opt.value = y; opt.textContent = y.toString();
                sel.appendChild(opt);
              }
              sel.classList.add("text-sm");
            });
          },

          updateIndexes: () => {
            const items = els.container.querySelectorAll(".dem-item");
            items.forEach((item, idx) => {
               const i = idx + 1;
               const badge = item.querySelector(".dem-index");
               if(badge) badge.style.display = 'none';
               
               const h3 = item.querySelector("h3");
               if(h3) {
                 // Clean old text nodes
                 Array.from(h3.childNodes).filter(n => n.nodeType === Node.TEXT_NODE).forEach(n => n.remove());
                 // Insert new text
                 let title = h3.querySelector(".dem-title-text");
                 if(!title) { 
                    title = document.createElement("span"); title.className = "dem-title-text ml-1"; 
                    h3.prepend(title);
                 }
                 title.textContent = `ชุดข้อมูลที่ ${i}`;
               }

               const rmBtn = item.querySelector(".btn-remove-dem-item");
               if(rmBtn) {
                 rmBtn.classList.toggle("hidden", items.length === 1);
                 rmBtn.classList.add("bg-rose-600", "text-white", "border-rose-600", "hover:bg-rose-700");
                 rmBtn.classList.remove("bg-white");
               }
            });
          },

          applyRefData: () => {
            if(!refData) return;
            document.querySelectorAll(".basin-select").forEach(s => Utils.populateSelect(s, refData.basins));
            document.querySelectorAll(".province-select").forEach(s => Utils.populateSelect(s, refData.provinces));
          },

          resetForm: () => {
             els.form.reset();
             // Keep only first item
             const items = els.container.querySelectorAll(".dem-item");
             items.forEach((item, i) => { if(i > 0) item.remove(); });
             
             // Reset UI state of first item
             const first = els.container.querySelector(".dem-item");
             if(first) {
                first.querySelectorAll(".basin-tags, .province-tags").forEach(e => e.innerHTML = "");
                first.querySelectorAll(".basin-other-input, .province-other-input").forEach(e => e.value = "");
                first.querySelectorAll(".basin-block, .province-block, .local-block").forEach(e => e.classList.add("hidden"));
                const localIn = first.querySelector(".local-input");
                if(localIn) { localIn.disabled = true; Utils.clearError(localIn); }
                
                // Re-attach to ensure state consistency
                FormHandler.attachEvents(first);
             }
             
             FormHandler.updateIndexes();
             FormHandler.populateYears();
             FormHandler.applyRefData();
             els.form.querySelectorAll(".error-text-msg").forEach(e => e.remove());
             els.form.querySelectorAll(".border-red-500").forEach(e => Utils.clearError(e));
          }
        };

        // --- FORM ACTION HANDLERS ---

        els.addBtn.addEventListener("click", () => {
           const clone = els.container.querySelector(".dem-item").cloneNode(true);
           // Reset values
           clone.querySelectorAll("input, textarea, select").forEach(el => {
              if (el.tagName === "SELECT") el.selectedIndex = 0;
              else if (el.type === "checkbox" || el.type === "radio") { el.checked = false; el.disabled = false; }
              else el.value = "";
              Utils.clearError(el);
           });
           // Reset specific dynamic UI parts
           clone.querySelectorAll(".basin-tags, .province-tags").forEach(e => e.innerHTML = "");
           clone.querySelectorAll(".hidden").forEach(e => {
              // Don't unhide wrappers, keep them hidden. Logic handles toggles.
           });
           // Re-hide toggle wrappers that might be open in clone
           CONFIG.TOGGLE_FIELDS.forEach(c => {
              if(c.wrapper) clone.querySelector(c.wrapper)?.classList.add("hidden");
              const inp = clone.querySelector(c.input);
              if(inp) inp.disabled = true;
           });
           // Re-hide blocks
           clone.querySelectorAll(".basin-block, .province-block, .local-block").forEach(e => e.classList.add("hidden"));
           
           els.container.appendChild(clone);
           FormHandler.attachEvents(clone);
           FormHandler.populateYears();
           FormHandler.updateIndexes();
           FormHandler.applyRefData();
        });

        els.resetBtn.addEventListener("click", (e) => {
           e.preventDefault();
           Modals.openConfirm("ยืนยันล้างข้อมูล", "คุณต้องการล้างค่าทั้งหมดในแบบฟอร์มหรือไม่?", FormHandler.resetForm);
        });

        const validateForm = () => {
           let isValid = true;
           let firstErr = null;
           const inputs = els.form.querySelectorAll("[required]:not([disabled])");
           inputs.forEach(input => {
              if(!input.value.trim()) {
                 Utils.showError(input, "* จำเป็น (โปรดระบุ)");
                 isValid = false;
                 if(!firstErr) firstErr = input;
                 input.addEventListener("input", function() { Utils.clearError(this); }, {once:true});
                 input.addEventListener("change", function() { Utils.clearError(this); }, {once:true});
              } else {
                 Utils.clearError(input);
              }
           });
           if(firstErr) {
              firstErr.scrollIntoView({ behavior: "smooth", block: "center" });
              firstErr.focus();
           }
           return isValid;
        };

        const collectData = () => {
           // Helper
           const getVal = (itm, sel) => itm.querySelector(sel)?.value.trim() || "";
           const getCheck = (itm, sel, excl=false) => Utils.getCheckedValues(itm, sel, excl);
           const getOther = (itm, chkName, inpName) => {
              const has = itm.querySelector(`input[name="${chkName}"]`)?.checked;
              return has ? (itm.querySelector(`input[name="${inpName}"]`)?.value.trim() || "") : "";
           };

           const agency = {
              agencyName: document.getElementById("agencyName").value.trim(),
              subUnit: document.getElementById("subUnit").value.trim(),
              contactName: document.getElementById("contactName").value.trim(),
              contactPosition: document.getElementById("contactPosition").value.trim(),
              contactPhone: document.getElementById("contactPhone").value.trim(),
              contactEmail: document.getElementById("contactEmail").value.trim(),
           };

           const items = [];
           els.container.querySelectorAll(".dem-item").forEach(item => {
              const d = {};
              d.demName = getVal(item, 'input[name="demName[]"]');
              
              // Source
              const srcSel = item.querySelector('select[name="sourceType[]"]');
              d.sourceType = (srcSel?.value === 'other') ? getVal(item, 'input[name="sourceOther[]"]') : (srcSel?.value || "");
              
              d.year = getVal(item, 'select[name="year[]"]');

              // Coverage
              const rawCountry = getCheck(item, 'input[name="coverageCountry[]"]');
              d.coverageCountry = rawCountry.map(v => v === 'thailand_all' ? 'ทั่วประเทศ' : v);
              d.coverageBasinTags = getVal(item, '.basin-other-input');
              d.coverageProvinceTags = getVal(item, '.province-other-input');
              d.coverageLocal = getVal(item, 'input[name="coverageLocal[]"]');

              // Tech
              const resSel = item.querySelector('select[name="resolution[]"]');
              d.resolution = (resSel?.value === 'other' || resSel?.value === 'lidar_sub1m') ? getVal(item, 'input[name="resolutionOther[]"]') : (resSel?.value || "");
              
              d.verticalAccuracy = getVal(item, 'input[name="verticalAccuracy[]"]');
              d.horizontalAccuracy = getVal(item, 'input[name="horizontalAccuracy[]"]');
              
              const vDatSel = item.querySelector('select[name="verticalDatum[]"]');
              d.verticalDatum = (vDatSel?.value === 'other') ? getVal(item, 'input[name="verticalDatumOther[]"]') : (vDatSel?.value || "");

              const coSel = item.querySelector('select[name="coordSys[]"]');
              d.coordSys = (coSel?.value === 'other') ? getVal(item, 'input[name="coordSysOther[]"]') : (coSel?.value || "");

              // Multi-checkbox with Other
              d.demMethods = getCheck(item, 'input[name^="demMethod"]', true);
              const dmOther = getOther(item, 'demMethodOtherFlag[]', 'demMethodOther[]');
              if(dmOther) d.demMethods.push(dmOther);

              d.fileFormats = getCheck(item, 'input[name^="format"]', true);
              const fmtOther = getOther(item, 'formatOtherFlag[]', 'formatOther[]');
              if(fmtOther) d.fileFormats.push(fmtOther);

              d.fileSize = getVal(item, 'input[name="fileSize[]"]');
              d.fileSizeUnit = getVal(item, 'select[name="fileSizeUnit[]"]');

              const licSel = item.querySelector('select[name="license[]"]');
              d.license = (licSel?.value === 'other') ? getVal(item, 'input[name="licenseOther[]"]') : (licSel?.value || "");

              d.accessChannels = getCheck(item, 'input[name^="access"]', true);
              const accOther = getOther(item, 'accessOtherFlag[]', 'accessOther[]');
              if(accOther) d.accessChannels.push(accOther); // Assuming backend expects array or appended string logic from previous, keeping consistant with "Other" field

              d.accessOther = getVal(item, 'input[name="accessOther[]"]'); // Legacy field mapping if needed separately

              d.qcQa = getCheck(item, 'input[name^="qc"]', true);
              d.qcQaOther = getVal(item, 'input[name="qcOther[]"]');

              d.mainUses = getCheck(item, 'input[name^="use"]', true);
              d.mainUsesOther = getVal(item, 'input[name="useOther[]"]');

              d.remark = getVal(item, 'textarea[name="remark[]"]');
              items.push(d);
           });

           return { agency, items };
        };

        els.form.addEventListener("submit", (e) => {
           e.preventDefault();
           if(!validateForm()) return;

           Modals.openConfirm("ยืนยันการส่งแบบฟอร์ม", "โปรดตรวจสอบข้อมูลให้ถูกต้อง ก่อนยืนยันการส่งแบบฟอร์ม", async () => {
              const payload = collectData();
              try {
                 const res = await fetch(CONFIG.API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload),
                 });
                 const data = await res.json();
                 if(data && (data.success || data.result === "success")) { // flexible check
                    Modals.openSuccess();
                    FormHandler.resetForm(); // Auto reset on success
                 } else {
                    alert("บันทึกข้อมูลไม่สำเร็จ กรุณาลองใหม่อีกครั้ง");
                 }
              } catch(err) {
                 console.error("Submit Error", err);
                 alert("เกิดข้อผิดพลาดในการเชื่อมต่อ");
              }
           });
        });

        // Initialize App
        init();

      })();
    </script>
  </body>
</html>
