<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>แบบฟอร์มสำรวจข้อมูล DEM ของหน่วยงานรัฐในประเทศไทย</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      body {
        font-family: "Sarabun", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }
      select[multiple] {
        min-height: 3.5rem;
      }

/* toggle-pill (ปรับขนาดให้เล็กลง) */
      .toggle-pill {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 54px; /* ลดความกว้าง */
        height: 22px;    /* ลดความสูง */
        border-radius: 9999px;
        cursor: pointer;
        border: none;
        outline: none;
        transition: background-color 0.25s ease;
        padding: 0;      /* เอา padding เดิมออกเพื่อจัดระยะด้วย margin */
        background-color: #94a3b8;
      }

      /* toggle-knob (วงกลมเล็กลง) */
      .toggle-pill .toggle-knob {
        width: 16px;     /* ลดขนาดวงกลม */
        height: 16px;    /* ลดขนาดวงกลม */
        border-radius: 50%;
        background: #ffffff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        position: absolute;
        top: 3px;        /* จัดกึ่งกลางแนวตั้ง (22-16)/2 = 3 */
        transition: left 0.25s ease, right 0.25s ease;
      }

      /* toggle-label (ข้อความ) */
      .toggle-label {
        display: inline-block;
        color: #ffffff;
        font-size: 10px; /* ลดขนาดฟอนต์เล็กน้อย */
        font-weight: 600;
        pointer-events: none;
        transition: margin 0.25s ease; /* เพิ่ม transition ให้ข้อความขยับนุ่มนวล */
      }

      /* --- สถานะ: SHOWN (สีเขียว / เปิด) --- */
      /* ปุ่มอยู่ขวา -> ข้อความต้องอยู่ซ้าย */
      .toggle-pill[data-state="shown"] {
        background-color: #22c55e;
      }
      .toggle-pill[data-state="shown"] .toggle-knob {
        left: auto;
        right: 3px; /* ชิดขวา */
      }
      .toggle-pill[data-state="shown"] .toggle-label {
        margin-right: 14px; /* ดันข้อความไปทางซ้าย หนีจากปุ่ม */
        margin-left: 0;
      }

      /* --- สถานะ: HIDDEN (สีเทา / ปิด) --- */
      /* ปุ่มอยู่ซ้าย -> ข้อความต้องอยู่ขวา */
      .toggle-pill[data-state="hidden"] {
        background-color: #94a3b8;
      }
      .toggle-pill[data-state="hidden"] .toggle-knob {
        left: 3px;  /* ชิดซ้าย */
        right: auto;
      }
      .toggle-pill[data-state="hidden"] .toggle-label {
        margin-left: 14px; /* ดันข้อความไปทางขวา หนีจากปุ่ม */
        margin-right: 0;
      }

      /* Tag แบบ C (pill) สำหรับลุ่มน้ำ / จังหวัด */
      .tag-pill {
        display: inline-flex;
        align-items: center;
        padding: 0rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        background-color: #dbeafe; /* blue-100 */
        color: #1d4ed8; /* blue-700 */
        cursor: default;
        /* margin-right: 0.25rem;
        margin-bottom: 0.25rem; */
        position: relative;
        z-index: 10;
      }
      /* .tag-pill .tag-text {
        margin-right: 0.25rem;
      } */
      .tag-pill .tag-remove {
        font-weight: 600;
        cursor: pointer;
      }

      .field-error {
        color: #dc2626; /* red-600 */
        font-size: 12px;
        margin-top: 4px;
      }
      .error-border {
        border-color: #dc2626 !important;
      }
      
    </style>
  </head>
  <body class="min-h-screen bg-slate-100">
      <div class="mx-auto max-w-5xl px-4 py-8 sm:px-6 lg:px-8">
        <div
          class="rounded-2xl bg-white shadow-lg px-4 py-5 sm:px-6 sm:py-6 lg:px-8"
        >
          <header class="border-b border-slate-200 pb-3 mb-5">
            <div class="flex items-center gap-4">
              <img
                src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fd/Emblem_of_the_Office_of_the_National_Water_Resources.svg/240px-Emblem_of_the_Office_of_the_National_Water_Resources.svg.png"
                alt="สทนช. Emblem"
                class="h-12 w-12 object-contain"
              />
              <div>
                <h1 class="text-xl sm:text-2xl font-semibold text-slate-800">
                  แบบฟอร์มสำรวจข้อมูล DEM ของหน่วยงานรัฐในประเทศไทย
                </h1>
                <p class="text-sm text-slate-600 mt-1">
                  สำนักงานทรัพยากรน้ำแห่งชาติ (สทนช.) จัดทำแบบสำรวจเพื่อรวบรวมข้อมูล DEM
                  จากหน่วยงานต่าง ๆ เพื่อใช้ในการวางแผน บริหารจัดการทรัพยากรน้ำ และการลดความเสี่ยงจากภัยพิบัติ
                </p>
              </div>
            </div>
          </header>
  
          <!-- แบบฟอร์มหลัก -->
          <form id="demSurveyForm" class="space-y-8">
            <!-- ส่วนที่ 1: ข้อมูลหน่วยงาน -->
            <section
              class="rounded-xl border border-slate-200 bg-slate-50/60 px-4 py-4 sm:px-5 sm:py-5"
            >
              <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold text-slate-800">
                  ส่วนที่ 1: ข้อมูลหน่วยงาน
                </h2>
                <p class="text-xs text-rose-600">
                  * กรุณากรอกข้อมูลให้ครบถ้วน
                </p>
              </div>
  
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- ชื่อหน่วยงาน -->
                <div>
                  <label
                    for="agencyName"
                    class="block text-sm font-medium text-slate-700 mb-1"
                    >ชื่อหน่วยงานหลัก (ภาษาไทย)</label
                  >
                  <input
                    type="text"
                    id="agencyName"
                    name="agencyName"
                    class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น สำนักงานทรัพยากรน้ำแห่งชาติ (สทนช.)"
                  />
                  <div class="error-msg"></div>
                </div>
  
                <!-- หน่วยงานย่อย -->
                <div>
                  <label
                    for="subUnit"
                    class="block text-sm font-medium text-slate-700 mb-1"
                    >หน่วยงาน / กลุ่มงาน / ส่วน / ศูนย์ (ถ้ามี)</label
                  >
                  <input
                    type="text"
                    id="subUnit"
                    name="subUnit"
                    class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น กลุ่มงานแผนที่และภูมิสารสนเทศ"
                  />
                  <div class="error-msg"></div>
                </div>
  
                <!-- ชื่อผู้ประสานงาน -->
                <div>
                  <label
                    for="contactName"
                    class="block text-sm font-medium text-slate-700 mb-1"
                    >ชื่อ–สกุล ผู้ประสานงานหลัก</label
                  >
                  <input
                    type="text"
                    id="contactName"
                    name="contactName"
                    class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น นายตัวอย่าง ทดสอบระบบ"
                  />
                  <div class="error-msg"></div>
                </div>
  
                <!-- ตำแหน่ง -->
                <div>
                  <label
                    for="contactPosition"
                    class="block text-sm font-medium text-slate-700 mb-1"
                    >ตำแหน่ง</label
                  >
                  <input
                    type="text"
                    id="contactPosition"
                    name="contactPosition"
                    class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น นักวิเคราะห์นโยบายและแผนชำนาญการ"
                  />
                  <div class="error-msg"></div>
                </div>
  
                <!-- โทรศัพท์ -->
                <div>
                  <label
                    for="contactPhone"
                    class="block text-sm font-medium text-slate-700 mb-1"
                    >เบอร์โทรศัพท์ติดต่อ</label
                  >
                  <input
                    type="text"
                    id="contactPhone"
                    name="contactPhone"
                    class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น 021234567 หรือ 0912345678"
                  />
                  <div class="error-msg"></div>
                </div>
  
                <!-- อีเมล -->
                <div>
                  <label
                    for="contactEmail"
                    class="block text-sm font-medium text-slate-700 mb-1"
                    >อีเมลสำหรับติดต่อ</label
                  >
                  <input
                    type="email"
                    id="contactEmail"
                    name="contactEmail"
                    class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="เช่น example@onwr.go.th"
                  />
                  <div class="error-msg"></div>
                </div>
              </div>
            </section>
  
            <!-- ส่วนที่ 2: รายการชุดข้อมูล DEM -->
            <section class="space-y-4">
              <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-800">
                  ส่วนที่ 2: รายการชุดข้อมูล DEM ของหน่วยงาน
                </h2>
                <button
                  type="button"
                  id="btnAddDemItem"
                  class="inline-flex items-center rounded-full border border-blue-500 px-3 py-1.5 text-xs font-medium text-blue-600 hover:bg-blue-50"
                >
                  <span class="mr-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-blue-500 text-white"
                    ><i class="fa-solid fa-plus text-[10px]"></i
                  ></span>
                  เพิ่มชุดข้อมูล DEM
                </button>
              </div>
  
              <div id="demItemsContainer" class="space-y-4">
                <article
                  class="dem-item rounded-xl border border-slate-200 bg-white px-3 py-3 sm:px-4 sm:py-4"
                >
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <span
                        class="dem-index inline-flex h-7 w-7 items-center justify-center rounded-full bg-blue-600 text-xs font-semibold text-white"
                        >#1</span
                      >
                      <h3 class="text-sm font-semibold text-slate-800">
                        ชุดข้อมูลที่ 1
                      </h3>
                    </div>
                    <button
                      type="button"
                      class="btn-remove-dem-item inline-flex items-center rounded-full border border-slate-300 bg-white px-2.5 py-1 text-xs text-slate-600 hover:bg-rose-50 hover:text-rose-600"
                    >
                      <i class="fa-solid fa-trash-can mr-1 text-[11px]"></i>
                      ลบชุดข้อมูล
                    </button>
                  </div>
  
                  <!-- Toggle ทั้งชุด A B C -->
                  <div class="flex justify-end mb-2">
                    <button
                      type="button"
                      class="item-toggle-all inline-flex items-center rounded-full border border-slate-300 px-2.5 py-1 text-[11px] text-slate-600 hover:bg-slate-50"
                      data-state="shown"
                    >
                      <i class="fa-solid fa-eye-slash mr-1"></i>
                      <span class="toggle-label">ซ่อน</span>
                    </button>
                  </div>
  
                  <div class="space-y-3 sm:space-y-4">
                    <!-- Section A -->
                    <div
                      class="section-card rounded-lg border border-slate-200 bg-slate-50/80"
                    >
                      <div
                        class="flex items-center justify-between px-3 py-2 border-b border-slate-200"
                      >
                        <div class="flex items-center gap-2">
                          <span
                            class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-blue-600 text-[11px] font-semibold text-white"
                          >
                            A
                          </span>
                          <p class="text-sm font-semibold text-slate-800">
                            ข้อมูลทั่วไปของชุดข้อมูล DEM
                          </p>
                        </div>
                        <button
                          type="button"
                          class="section-toggle inline-flex items-center rounded-full border border-slate-300 px-2 py-1 text-[11px] text-slate-600 hover:bg-slate-100"
                          data-state="shown"
                        >
                          <i class="fa-solid fa-chevron-up mr-1 text-[10px]"></i>
                          <span class="toggle-label">ซ่อน</span>
                        </button>
                      </div>
  
                      <div class="section-body space-y-3">
                        <div
                          class="flex flex-col gap-3 sm:flex-row sm:items-end"
                        >
                          <!-- A1 -->
                          <div class="sm:basis-[60%]">
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >1. ชื่อชุดข้อมูล DEM</label
                            >
                            <input
                              type="text"
                              name="demName[]"
                              class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="เช่น DEM LiDAR พ.ศ. 2566 พื้นที่ลุ่มน้ำบางปะกง"
                            />
                                <div class="error-msg"></div>
                          </div>
  
                          <!-- A2 -->
                          <div class="sm:basis-[25%]">
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >2. แหล่งที่มา / ผู้ผลิตข้อมูล</label
                            >
                            <select
                              name="sourceType[]"
                              class="source-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                              <option value="">-- เลือกแหล่งที่มา --</option>
                              <option value="self">หน่วยงานผลิตเอง</option>
                              <option value="rtsd">กรมแผนที่ทหาร</option>
                              <option value="gistda">GISTDA</option>
                              <option value="ldd">กรมพัฒนาที่ดิน</option>
                              <option value="other">อื่น ๆ (ระบุ)</option>
                            </select>
                                <div class="error-msg"></div>
                            <div class="source-other-wrapper mt-1 hidden">
                              <input
                                type="text"
                                name="sourceOther[]"
                                class="source-other-input block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="ระบุหน่วยงาน / บริษัท"
                                disabled
                              />
                                <div class="error-msg"></div>
                            </div>
                          </div>
  
                          <!-- A3 -->
                          <div class="sm:basis-[15%]">
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >3. ปีที่จัดทำ (พ.ศ.)</label
                            >
                            <select
                              name="year[]"
                              class="year-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                              <option value="">เลือกปี</option>
                            </select>
                                <div class="error-msg"></div>
                          </div>
                        </div>
  
                        <!-- A4 -->
                        <div>
                          <label
                            class="block text-sm font-medium text-slate-700 mb-1"
                            >4. ขอบเขตพื้นที่ที่ครอบคลุม</label
                          >
  
                          <div
                            class="grid grid-cols-1 lg:grid-cols-2 gap-3 border border-slate-200 rounded-lg bg-white/60 px-3 py-3"
                          >
                            <div class="space-y-2">
                              <p class="text-xs font-medium text-slate-600">
                                เลือกได้อย่างใดอย่างหนึ่งในหัวข้อนี้
                              </p>
  
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="coverageCountry[]"
                                  value="all_country"
                                  class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                                />
                                <span class="text-sm text-slate-700">
                                  ครอบคลุมพื้นที่ประเทศไทยทั้งหมด
                                </span>
                              </label>
  
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  class="toggle-basin h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                                />
                                <span class="text-sm text-slate-700">
                                  ครอบคลุมหลายลุ่มน้ำ (เลือกจากรายชื่อลุ่มน้ำ)
                                </span>
                              </label>
  
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  class="toggle-province h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                                />
                                <span class="text-sm text-slate-700">
                                  ครอบคลุมหลายจังหวัด (เลือกจากรายชื่อจังหวัด)
                                </span>
                              </label>
  
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  class="toggle-local h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                                />
                                <span class="text-sm text-slate-700">
                                  พื้นที่เฉพาะจุด / โครงการเฉพาะพื้นที่
                                </span>
                              </label>
                            </div>
  
                            <div class="space-y-3">
                              <!-- กลุ่มลุ่มน้ำ -->
                              <div class="basin-block hidden space-y-1">
                                <p class="text-xs font-medium text-slate-600">
                                  ลุ่มน้ำที่ครอบคลุม (ดับเบิลคลิกที่รายชื่อลุ่มน้ำเพื่อเพิ่มลงในแท็ก)
                                </p>
                                <div class="flex items-center gap-2">
                                  <span class="text-xs text-slate-500"
                                    >พิมพ์เพื่อค้นหา:</span
                                  >
                                  <input
                                    type="text"
                                    class="basin-search flex-1 rounded-md border border-slate-300 px-2 py-1 text-xs focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    placeholder="ค้นหาลุ่มน้ำ"
                                  />
                                </div>
                                <select
                                  class="basin-select mt-1 block w-full rounded-md border border-slate-300 bg-white px-2 py-1.5 text-xs focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                  size="6"
                                >
                                  <option value="">-- เลือกลุ่มน้ำ --</option>
                                  <option>เจ้าพระยา</option>
                                  <option>แม่กลอง</option>
                                  <option>ป่าสัก</option>
                                </select>
                                <div
                                  class="basin-tags mt-2 flex flex-wrap gap-1 text-xs"
                                ></div>
                                <input
                                  type="hidden"
                                  name="coverageBasinOther[]"
                                  class="basin-other-input"
                                />
                              </div>
  
                              <!-- กลุ่มจังหวัด -->
                              <div class="province-block hidden space-y-1">
                                <p class="text-xs font-medium text-slate-600">
                                  จังหวัดที่ครอบคลุม (ดับเบิลคลิกที่รายชื่อจังหวัดเพื่อเพิ่มลงในแท็ก)
                                </p>
                                <div class="flex items-center gap-2">
                                  <span class="text-xs text-slate-500"
                                    >พิมพ์เพื่อค้นหา:</span
                                  >
                                  <input
                                    type="text"
                                    class="province-search flex-1 rounded-md border border-slate-300 px-2 py-1 text-xs focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                    placeholder="ค้นหาจังหวัด"
                                  />
                                </div>
                                <select
                                  class="province-select mt-1 block w-full rounded-md border border-slate-300 bg-white px-2 py-1.5 text-xs focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                  size="6"
                                >
                                  <option value="">-- เลือกจังหวัด --</option>
                                  <option>กรุงเทพมหานคร</option>
                                  <option>นนทบุรี</option>
                                  <option>ปทุมธานี</option>
                                </select>
                                <div
                                  class="province-tags mt-2 flex flex-wrap gap-1 text-xs"
                                ></div>
                                <input
                                  type="hidden"
                                  name="coverageProvinceOther[]"
                                  class="province-other-input"
                                />
                              </div>
  
                              <!-- พื้นที่เฉพาะจุด -->
                              <div class="space-y-1 local-block hidden">
                                <p class="text-xs font-medium text-slate-600">
                                  กรณีเป็น DEM พื้นที่เฉพาะจุด ให้ระบุพื้นที่โดยสังเขป
                                </p>
                                <textarea
                                  name="coverageLocal[]"
                                  rows="3"
                                  class="local-input block w-full rounded-md border border-slate-300 px-3 py-2 text-xs focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="เช่น DEM ลุ่มน้ำคลองแสนแสบตอนล่าง, DEM รอบเขื่อนป่าสักฯ, DEM พื้นที่รัศมี 5 กม. รอบสถานีสูบน้ำ เป็นต้น"
                                ></textarea>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
  
                    <!-- Section B -->
                    <div
                      class="section-card rounded-lg border border-slate-200 bg-slate-50/80"
                    >
                      <div
                        class="flex items-center justify-between px-3 py-2 border-b border-slate-200"
                      >
                        <div class="flex items-center gap-2">
                          <span
                            class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-600 text-[11px] font-semibold text-white"
                          >
                            B
                          </span>
                          <p class="text-sm font-semibold text-slate-800">
                            รายละเอียดเชิงเทคนิคของ DEM
                          </p>
                        </div>
                        <button
                          type="button"
                          class="section-toggle inline-flex items-center rounded-full border border-slate-300 px-2 py-1 text-[11px] text-slate-600 hover:bg-slate-100"
                          data-state="shown"
                        >
                          <i class="fa-solid fa-chevron-up mr-1 text-[10px]"></i>
                          <span class="toggle-label">ซ่อน</span>
                        </button>
                      </div>
  
                      <div class="section-body space-y-3 px-3 py-3">
                        <!-- B1–3 -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >1. ประเภทของ DEM</label
                            >
                            <div class="space-y-1">
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="demType[]"
                                  value="dsm"
                                  class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                                />
                                <span class="text-sm text-slate-700">DSM</span>
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="demType[]"
                                  value="dtm"
                                  class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                                />
                                <span class="text-sm text-slate-700">DTM</span>
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="demType[]"
                                  value="other"
                                  class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                                />
                                <span class="text-sm text-slate-700"
                                  >อื่น ๆ (ระบุในหมายเหตุ)</span
                                >
                              </label>
                            </div>
                          </div>
  
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >2. ช่วงค่าระดับความสูงโดยประมาณ</label
                            >
                            <input
                              type="text"
                              name="elevationRange[]"
                              class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                              placeholder="เช่น 0–50 m MSL"
                            />
                          </div>
  
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >3. ความหนาแน่นของจุด (ถ้ามี)</label
                            >
                            <input
                              type="text"
                              name="pointDensity[]"
                              class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                              placeholder="เช่น 4 จุด/ตร.ม. (สำหรับ LiDAR)"
                            />
                          </div>
                        </div>
  
                        <!-- B4–6 -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >4. ความละเอียดเชิงเวลา (ถ้ามีการสำรวจหลายช่วงเวลา)</label
                            >
                            <input
                              type="text"
                              name="temporalResolution[]"
                              class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                              placeholder="เช่น สำรวจปี 2562–2564 ทุก 1 ปี"
                            />
                          </div>
  
                          <!-- B5 Resolution -->
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >5. ความละเอียดเชิงพื้นที่ (Resolution)</label
                            >
                            <select
                              name="resolution[]"
                              class="resolution-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                            >
                              <option value="">-- เลือกความละเอียด --</option>
                              <option value="0.5m">0.5 m</option>
                              <option value="1m">1 m</option>
                              <option value="2m">2 m</option>
                              <option value="5m">5 m</option>
                              <option value="10m">10 m</option>
                              <option value="30m">30 m</option>
                              <option value="other">อื่น ๆ (ระบุ)</option>
                            </select>
                                <div class="error-msg"></div>
                            <div class="resolution-other-wrapper mt-1 hidden">
                              <input
                                type="text"
                                name="resolutionOther[]"
                                class="resolution-other-input block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                placeholder="ระบุความละเอียดเชิงพื้นที่ เช่น 0.25 m"
                                disabled
                              />
                                <div class="error-msg"></div>
                            </div>
                          </div>
  
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >6. ความถูกต้องแนวดิ่ง (Vertical Accuracy)</label
                            >
                            <input
                              type="text"
                              name="verticalAccuracy[]"
                              class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                              placeholder="เช่น RMSEz = 10 cm"
                            />
                          </div>
                        </div>
  
                        <!-- B7–9 -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >7. ความถูกต้องแนวราบ (Horizontal Accuracy)</label
                            >
                            <input
                              type="text"
                              name="horizontalAccuracy[]"
                              class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                              placeholder="เช่น CE90 = 50 cm"
                            />
                          </div>
  
                          <!-- B8 Vertical Datum -->
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >8. Vertical Datum ที่ใช้</label
                            >
                            <select
                              name="verticalDatum[]"
                              class="vertical-datum-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                            >
                              <option value="">-- เลือก Vertical Datum --</option>
                              <option value="msl">Mean Sea Level (MSL)</option>
                              <option value="egm96">EGM96</option>
                              <option value="egm2008">EGM2008</option>
                              <option value="local">Local Datum</option>
                              <option value="other">อื่น ๆ (ระบุ)</option>
                            </select>
                                <div class="error-msg"></div>
                            <div class="vertical-datum-other-wrapper mt-1 hidden">
                              <input
                                type="text"
                                name="verticalDatumOther[]"
                                class="vertical-datum-other-input block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                placeholder="ระบุชื่อ Vertical Datum"
                                disabled
                              />
                                <div class="error-msg"></div>
                            </div>
                          </div>
  
                          <!-- B9 Coordinate System -->
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >9. ระบบพิกัด (Coordinate System)</label
                            >
                            <select
                              name="coordSys[]"
                              class="coord-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                            >
                              <option value="">-- เลือกระบบพิกัด --</option>
                              <option value="utm47n">UTM Zone 47N</option>
                              <option value="utm48n">UTM Zone 48N</option>
                              <option value="wgs84">WGS84 (Lat/Long)</option>
                              <option value="local">ระบบพิกัดท้องถิ่น</option>
                              <option value="other">อื่น ๆ (ระบุ)</option>
                            </select>
                                <div class="error-msg"></div>
                            <div class="coord-other-wrapper mt-1 hidden">
                              <input
                                type="text"
                                name="coordSysOther[]"
                                class="coord-other-input block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                placeholder="ระบุระบบพิกัด เช่น UTM Zone 47N on WGS84"
                                disabled
                              />
                                <div class="error-msg"></div>
                            </div>
                          </div>
                        </div>
  
                        <!-- B10–12 -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >10. วิธีการจัดทำ DEM (เลือกได้มากกว่า 1 ข้อ)</label
                            >
                            <div class="space-y-1">
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="demMethodLidar[]"
                                  value="lidar"
                                  class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                                />
                                <span class="text-sm text-slate-700">LiDAR</span>
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="demMethodStereo[]"
                                  value="stereo"
                                  class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                                />
                                <span class="text-sm text-slate-700"
                                  >Stereo Photogrammetry</span
                                >
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="demMethodSar[]"
                                  value="sar"
                                  class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                                />
                                <span class="text-sm text-slate-700">SAR</span>
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="demMethodOtherFlag[]"
                                  value="other"
                                  class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                                />
                                <span class="text-sm text-slate-700">อื่น ๆ</span>
                              </label>
                              <input
                                type="text"
                                name="demMethodOther[]"
                                class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                placeholder="ระบุวิธีอื่น ๆ เช่น RTK GNSS Survey + Interpolation"
                                disabled
                              />
                            </div>
                          </div>
  
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >11. รูปแบบไฟล์ DEM (เลือกได้มากกว่า 1 ข้อ)</label
                            >
                            <div class="space-y-1">
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="formatGeoTiff[]"
                                  value="geotiff"
                                  class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                                />
                                <span class="text-sm text-slate-700"
                                  >GeoTIFF</span
                                >
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="formatAscii[]"
                                  value="ascii"
                                  class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                                />
                                <span class="text-sm text-slate-700">ASCII</span>
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="formatLas[]"
                                  value="las"
                                  class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                                />
                                <span class="text-sm text-slate-700">LAS/LAZ</span>
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="formatOtherFlag[]"
                                  value="other"
                                  class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
                                />
                                <span class="text-sm text-slate-700">อื่น ๆ</span>
                              </label>
                              <input
                                type="text"
                                name="formatOther[]"
                                class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                placeholder="ระบุไฟล์อื่น ๆ เช่น .xyz, .dtm, ฯลฯ"
                                disabled
                              />
                            </div>
                          </div>
  
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >12. ขนาดไฟล์ข้อมูล DEM โดยประมาณ</label
                            >
                            <div class="flex gap-2">
                              <input
                                type="number"
                                name="fileSize[]"
                                class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                                placeholder="เช่น 100"
                                min="0"
                                step="0.01"
                              />
                              <select
                                name="fileSizeUnit[]"
                                class="block w-28 rounded-md border border-slate-300 bg-white px-2 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                              >
                                <option value="MB">MB</option>
                                <option value="GB">GB</option>
                                <option value="TB">TB</option>
                              </select>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
  
                    <!-- Section C -->
                    <div
                      class="section-card rounded-lg border border-slate-200 bg-slate-50/80"
                    >
                      <div
                        class="flex items-center justify-between px-3 py-2 border-b border-slate-200"
                      >
                        <div class="flex items-center gap-2">
                          <span
                            class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-purple-600 text-[11px] font-semibold text-white"
                          >
                            C
                          </span>
                          <p class="text-sm font-semibold text-slate-800">
                            การจัดเก็บ การเข้าถึง และการใช้งาน DEM
                          </p>
                        </div>
                        <button
                          type="button"
                          class="section-toggle inline-flex items-center rounded-full border border-slate-300 px-2 py-1 text-[11px] text-slate-600 hover:bg-slate-100"
                          data-state="shown"
                        >
                          <i class="fa-solid fa-chevron-up mr-1 text-[10px]"></i>
                          <span class="toggle-label">ซ่อน</span>
                        </button>
                      </div>
  
                      <div class="section-body space-y-3 px-3 py-3">
                        <!-- C1–3 -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >1. หน่วยงานผู้ดูแลจัดเก็บ DEM ปัจจุบัน</label
                            >
                            <input
                              type="text"
                              name="storageAgency[]"
                              class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="เช่น สสน., กรมแผนที่ทหาร, กรมพัฒนาที่ดิน ฯลฯ"
                            />
                          </div>
  
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >2. ช่องทางการจัดเก็บหลัก</label
                            >
                            <input
                              type="text"
                              name="storageLocation[]"
                              class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="เช่น Data Center ภายในหน่วยงาน, Cloud, External HDD ฯลฯ"
                            />
                          </div>
  
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >3. มีการสำรองข้อมูล (Backup) หรือไม่</label
                            >
                            <select
                              name="hasBackup[]"
                              class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            >
                              <option value="">-- เลือก --</option>
                              <option value="yes">มี</option>
                              <option value="no">ไม่มี</option>
                            </select>
                          </div>
                        </div>
  
                        <!-- C4–6 -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >4. ช่องทางการเข้าถึงข้อมูล DEM (เลือกได้มากกว่า
                              1 ข้อ)</label
                            >
                            <div class="space-y-1">
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="accessPortal[]"
                                  value="portal"
                                  class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500"
                                />
                                <span class="text-sm text-slate-700"
                                  >ผ่าน Web Portal ภายใน / ภายนอก</span
                                >
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="accessApi[]"
                                  value="api"
                                  class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500"
                                />
                                <span class="text-sm text-slate-700"
                                  >ผ่าน API / Web Service</span
                                >
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="accessRequest[]"
                                  value="on_request"
                                  class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500"
                                />
                                <span class="text-sm text-slate-700"
                                  >ให้บริการตามคำขอ (ส่งไฟล์ / HDD / อื่น ๆ)</span
                                >
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="accessOtherFlag[]"
                                  value="other"
                                  class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500"
                                />
                                <span class="text-sm text-slate-700">อื่น ๆ</span>
                              </label>
                              <input
                                type="text"
                                name="accessOther[]"
                                class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ระบุช่องทางอื่น ๆ เช่น FTP, External Drive ฯลฯ"
                                disabled
                              />
                            </div>
                          </div>
  
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >5. กระบวนการ QC/QA ข้อมูล DEM</label
                            >
                            <div class="space-y-1">
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="qcStandard[]"
                                  value="standard"
                                  class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500"
                                />
                                <span class="text-sm text-slate-700"
                                  >มีมาตรฐาน QC/QA ที่ชัดเจน</span
                                >
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="qcSample[]"
                                  value="sample"
                                  class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500"
                                />
                                <span class="text-sm text-slate-700"
                                  >ตรวจสอบบางส่วน (Sample Check)</span
                                >
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="qcVisual[]"
                                  value="visual"
                                  class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500"
                                />
                                <span class="text-sm text-slate-700"
                                  >ตรวจสอบเชิงสายตา (Visual Check)</span
                                >
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="qcOtherFlag[]"
                                  value="other"
                                  class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500"
                                />
                                <span class="text-sm text-slate-700">อื่น ๆ</span>
                              </label>
                              <input
                                type="text"
                                name="qcOther[]"
                                class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ระบุกระบวนการ QC/QA อื่น ๆ"
                                disabled
                              />
                            </div>
                          </div>
  
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >6. การอัปเดต / ปรับปรุงข้อมูล DEM</label
                            >
                            <input
                              type="text"
                              name="updatePolicy[]"
                              class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="เช่น ปรับปรุงเมื่อมีโครงการใหม่, ปรับทุก 5 ปี ฯลฯ"
                            />
                          </div>
                        </div>
  
                        <!-- C7–9 -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >7. การใช้งานหลักของ DEM ชุดนี้</label
                            >
                            <div class="space-y-1">
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="useFlood[]"
                                  value="flood"
                                  class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500"
                                />
                                <span class="text-sm text-slate-700"
                                  >แบบจำลองน้ำท่วม / วิเคราะห์ความเสี่ยงน้ำหลาก</span
                                >
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="usePlanning[]"
                                  value="planning"
                                  class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500"
                                />
                                <span class="text-sm text-slate-700"
                                  >การวางแผนโครงสร้างพื้นฐาน / งานออกแบบ</span
                                >
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="useLanduse[]"
                                  value="landuse"
                                  class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500"
                                />
                                <span class="text-sm text-slate-700"
                                  >การจัดการการใช้ที่ดิน / ผังเมือง</span
                                >
                              </label>
                              <label class="inline-flex items-center gap-2">
                                <input
                                  type="checkbox"
                                  name="useOtherFlag[]"
                                  value="other"
                                  class="h-4 w-4 rounded border-slate-300 text-purple-600 focus:ring-purple-500"
                                />
                                <span class="text-sm text-slate-700">อื่น ๆ</span>
                              </label>
                              <input
                                type="text"
                                name="useOther[]"
                                class="mt-1 block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ระบุการใช้งานอื่น ๆ เช่น งานวิจัยเฉพาะเรื่อง ฯลฯ"
                                disabled
                              />
                            </div>
                          </div>
  
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >8. ข้อจำกัดการใช้งาน (ถ้ามี)</label
                            >
                            <textarea
                              name="limitations[]"
                              rows="3"
                              class="block w-full rounded-md border border-slate-300 px-3 py-2 text-xs focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="เช่น ใช้ได้เฉพาะฤดูแล้ง, ความคลาดเคลื่อนสูงในพื้นที่ป่า/ภูเขา ฯลฯ"
                            ></textarea>
                          </div>
  
                          <!-- C13 License -->
                          <div>
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >13. ลิขสิทธิ์ / เงื่อนไขการใช้ข้อมูล</label
                            >
                            <select
                              name="license[]"
                              class="license-select block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            >
                              <option value="">-- เลือกลิขสิทธิ์ / เงื่อนไข --</option>
                              <option value="internal"
                                >ใช้ภายในหน่วยงานเท่านั้น</option
                              >
                              <option value="gov"
                                >ใช้ระหว่างหน่วยงานภาครัฐ (MOU / ข้อตกลง)</option
                              >
                              <option value="restricted"
                                >จำกัดการเผยแพร่ / ต้องได้รับอนุญาตก่อน</option
                              >
                              <option value="open">เผยแพร่สาธารณะ (Open Data)</option>
                              <option value="other">อื่น ๆ (ระบุ)</option>
                            </select>
                                <div class="error-msg"></div>
                            <div class="license-other-wrapper mt-1 hidden">
                              <input
                                type="text"
                                name="licenseOther[]"
                                class="license-other-input block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="ระบุลิขสิทธิ์ / เงื่อนไขเพิ่มเติม เช่น CC-BY, CC-BY-SA ฯลฯ"
                                disabled
                              />
                                <div class="error-msg"></div>
                            </div>
                          </div>
                        </div>
  
                        <!-- C10–12 -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                          <div class="sm:col-span-3">
                            <label
                              class="block text-sm font-medium text-slate-700 mb-1"
                              >14. หมายเหตุเพิ่มเติม (ถ้ามี)</label
                            >
                            <textarea
                              name="remark[]"
                              rows="3"
                              class="block w-full rounded-md border border-slate-300 px-3 py-2 text-xs focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="เช่น ข้อมูล DEM นี้อยู่ระหว่างการปรับปรุง, มีการจำกัดพื้นที่เผยแพร่, ใช้เฉพาะโครงการ X ฯลฯ"
                            ></textarea>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </article>
              </div>
            </section>
  
            <!-- ปุ่มส่งฟอร์ม -->
            <div class="flex items-center justify-between pt-4 border-t border-slate-200">
              <button
                type="button"
                id="btnResetForm"
                class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50"
              >
                <i class="fa-solid fa-rotate-left mr-2"></i>
                ล้างแบบฟอร์ม
              </button>
  
              <button
                type="submit"
                class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
              >
                <i class="fa-solid fa-paper-plane mr-2"></i>
                บันทึกข้อมูลแบบสำรวจ DEM
              </button>
            </div>
          </form>
        </div>
      </div>
  
      <!-- Modal ยืนยันส่งฟอร์ม -->
      <div
        id="confirmModal"
        class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40"
      >
        <div class="w-full max-w-md rounded-2xl bg-white p-5 shadow-lg">
          <h3 id="confirmTitle" class="text-lg font-semibold text-slate-800 mb-2">
            ยืนยันการส่งแบบฟอร์ม
          </h3>
          <p id="confirmMessage" class="text-sm text-slate-600 mb-4">
            โปรดตรวจสอบข้อมูลให้ถูกต้อง ก่อนยืนยันการส่งแบบฟอร์ม
          </p>
          <div class="flex justify-end gap-2">
            <button
              type="button"
              id="confirmCancel"
              class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50"
            >
              ยกเลิก
            </button>
            <button
              type="button"
              id="confirmOk"
              class="inline-flex items-center rounded-lg bg-blue-600 px-3 py-1.5 text-sm font-semibold text-white hover:bg-blue-700"
            >
              ตกลง
            </button>
          </div>
        </div>
      </div>
  
      <!-- Modal บันทึกสำเร็จ -->
      <div
        id="successModal"
        class="fixed inset-0 z-40 hidden items-center justify-center bg-black/40"
      >
        <div class="w-full max-w-md rounded-2xl bg-white p-5 shadow-lg text-center">
          <div
            class="mx-auto mb-3 flex h-12 w-12 items-center justify-center rounded-full bg-emerald-100 text-emerald-600"
          >
            <i class="fa-solid fa-check text-xl"></i>
          </div>
          <h3 class="text-lg font-semibold text-slate-800 mb-1">
            บันทึกข้อมูลเรียบร้อยแล้ว
          </h3>
          <p class="text-sm text-slate-600 mb-4">
            ขอบคุณที่สละเวลากรอกข้อมูล DEM ข้อมูลนี้จะช่วยสนับสนุนการบริหารจัดการทรัพยากรน้ำของประเทศ
          </p>
          <div class="flex justify-center">
            <button
              type="button"
              id="successOk"
              class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-1.5 text-sm font-semibold text-white hover:bg-blue-700"
            >
              ปิดหน้าต่าง
            </button>
          </div>
        </div>
      </div>
    </body>

    <script>
      // ★★ ใส่ URL Web App ของ Apps Script ที่นี่ ★★
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbw8Wf9vZsQbksaG7dmtWxw2b26xzCxI0R1l.../exec";
    
      const demContainer = document.getElementById("demItemsContainer");
      const btnAddDemItem = document.getElementById("btnAddDemItem");
      const form = document.getElementById("demSurveyForm");
    
      // -------------------- ฟิลด์บังคับ ส่วนที่ 1 (ข้อมูลหน่วยงาน) --------------------
      const requiredAgencyIds = [
        "agencyName",
        "subUnit",
        "contactName",
        "contactPosition",
        "contactPhone",
        "contactEmail",
      ];
    
      // -------------------- ฟังก์ชันจัดการ error --------------------
      function clearValidationErrors() {
        document
          .querySelectorAll(".field-error-auto")
          .forEach((el) => el.remove());
        document.querySelectorAll(".error-border-auto").forEach((el) => {
          el.classList.remove("error-border-auto");
          el.style.borderColor = "";
        });
      }
    
      function showError(el, msg) {
        if (!el) return;
        el.classList.add("error-border-auto");
        el.style.borderColor = "#dc2626";
    
        let container = el.parentElement;
        if (!container) container = document.body;
    
        let err = container.querySelector(".field-error-auto");
        if (!err) {
          err = document.createElement("div");
          err.className = "field-error-auto";
          err.style.color = "#dc2626";
          err.style.fontSize = "12px";
          err.style.marginTop = "4px";
          container.appendChild(err);
        }
        err.textContent = msg;
      }
    
      function clearErrorForElement(el) {
        if (!el) return;
        el.classList.remove("error-border-auto");
        el.style.borderColor = "";
        const container = el.parentElement;
        if (!container) return;
        const err = container.querySelector(".field-error-auto");
        if (err) err.remove();
      }
    
      // ลบ error เมื่อเริ่มพิมพ์ใหม่
      document.addEventListener("input", (e) => {
        clearErrorForElement(e.target);
      });
    
      // -------------------- ฟอร์แมตและตรวจสอบเบอร์โทร --------------------
      (function setupPhoneValidation() {
        const phoneInput = document.getElementById("contactPhone");
        if (!phoneInput) return;
    
        function validatePhoneDigits() {
          const digits = phoneInput.value.replace(/\D/g, "");
          if (!digits) return true;
          return digits.length === 9 || digits.length === 10;
        }
    
        function formatPhone() {
          const digits = phoneInput.value.replace(/\D/g, "");
          if (digits.length === 9) {
            phoneInput.value = digits.replace(
              /^(\d{2})(\d{3})(\d{4})$/,
              "$1-$2-$3"
            );
          } else if (digits.length === 10) {
            phoneInput.value = digits.replace(
              /^(\d{3})(\d{3})(\d{4})$/,
              "$1-$2-$3"
            );
          }
        }
    
        phoneInput.addEventListener("blur", () => {
          if (!validatePhoneDigits()) {
            showError(
              phoneInput,
              "กรุณากรอกหมายเลขโทรศัพท์ 9 หรือ 10 หลัก (ไม่ต้องใส่ขีด)"
            );
          } else {
            clearErrorForElement(phoneInput);
            formatPhone();
          }
        });
      })();
    
      // -------------------- Confirm Modal --------------------
      const confirmModal = document.getElementById("confirmModal");
      const confirmTitle = document.getElementById("confirmTitle");
      const confirmMessage = document.getElementById("confirmMessage");
      const confirmCancel = document.getElementById("confirmCancel");
      const confirmOk = document.getElementById("confirmOk");
      let confirmCallback = null;
    
      function openConfirmModal(title, message, onConfirm) {
        if (!confirmModal) return;
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmCallback = onConfirm;
        confirmModal.classList.remove("hidden");
        confirmModal.classList.add("flex");
      }
    
      function closeConfirmModal() {
        if (!confirmModal) return;
        confirmModal.classList.add("hidden");
        confirmModal.classList.remove("flex");
        confirmCallback = null;
      }
    
      if (confirmCancel) confirmCancel.addEventListener("click", closeConfirmModal);
      if (confirmOk) {
        confirmOk.addEventListener("click", () => {
          if (typeof confirmCallback === "function") confirmCallback();
          closeConfirmModal();
        });
      }
      if (confirmModal) {
        confirmModal.addEventListener("click", (e) => {
          if (e.target === confirmModal) closeConfirmModal();
        });
      }
    
      // -------------------- Success Modal --------------------
      const successModal = document.getElementById("successModal");
      const successOk = document.getElementById("successOk");
    
      function openSuccessModal() {
        if (!successModal) return;
        successModal.classList.remove("hidden");
        successModal.classList.add("flex");
      }
    
      function closeSuccessModal() {
        if (!successModal) return;
        successModal.classList.add("hidden");
        successModal.classList.remove("flex");
      }
    
      if (successOk) successOk.addEventListener("click", closeSuccessModal);
      if (successModal) {
        successModal.addEventListener("click", (e) => {
          if (e.target === successModal) closeSuccessModal();
        });
      }
    
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeConfirmModal();
          closeSuccessModal();
        }
      });
    
      // -------------------- Year Select (2539–2568) --------------------
      function populateYearSelects() {
        const selects = document.querySelectorAll(".year-select");
        const startBE = 2539;
        const endBE = 2568;
    
        selects.forEach((sel) => {
          if (sel.dataset._filled === "1") return;
          for (let y = endBE; y >= startBE; y--) {
            const opt = document.createElement("option");
            opt.value = y;
            opt.textContent = y.toString();
            sel.appendChild(opt);
          }
          sel.dataset._filled = "1";
        });
      }
    
      // -------------------- DEM Index (ข้อมูลชุดที่ X) --------------------
      function updateDemIndexes() {
        const items = demContainer.querySelectorAll(".dem-item");
        items.forEach((item, index) => {
          const idx = index + 1;
    
          const badge = item.querySelector(".dem-index");
          if (badge) badge.style.display = "none";
    
          const header = item.querySelector("h3");
          if (header) {
            let titleSpan = header.querySelector(".dem-title-text");
            if (!titleSpan) {
              titleSpan = document.createElement("span");
              titleSpan.className = "dem-title-text";
              titleSpan.style.marginLeft = "4px";
    
              const toRemove = [];
              header.childNodes.forEach((node) => {
                if (
                  node.nodeType === Node.TEXT_NODE &&
                  node.textContent.trim()
                ) {
                  toRemove.push(node);
                }
              });
              toRemove.forEach((n) => header.removeChild(n));
    
              const removeBtn = header.querySelector(".btn-remove-dem-item");
              if (removeBtn) {
                header.insertBefore(titleSpan, removeBtn);
              } else {
                header.appendChild(titleSpan);
              }
            }
            titleSpan.textContent = `ชุดข้อมูลที่ ${idx}`;
          }
    
          const removeBtn = item.querySelector(".btn-remove-dem-item");
          if (removeBtn) {
            if (items.length === 1) {
              removeBtn.classList.add("hidden");
            } else {
              removeBtn.classList.remove("hidden");
            }
            removeBtn.classList.add(
              "bg-rose-600",
              "text-white",
              "border",
              "border-rose-600",
              "hover:bg-rose-700"
            );
            removeBtn.classList.remove("bg-white");
          }
        });
      }
    
      // -------------------- Section Toggle --------------------
      function setSectionVisibility(card, visible) {
        const body = card.querySelector(".section-body");
        const toggleBtn = card.querySelector(".section-toggle");
        if (!body || !toggleBtn) return;
        const label = toggleBtn.querySelector(".toggle-label");
        if (visible) {
          body.classList.remove("hidden");
          toggleBtn.dataset.state = "shown";
          if (label) label.textContent = "ซ่อน";
        } else {
          body.classList.add("hidden");
          toggleBtn.dataset.state = "hidden";
          if (label) label.textContent = "แสดง";
        }
      }
    
      function attachSectionToggles(item) {
        const cards = item.querySelectorAll(".section-card");
    
        // เริ่มต้น: แสดงแค่ A
        cards.forEach((card, idx) => {
          setSectionVisibility(card, idx === 0);
        });
    
        cards.forEach((card) => {
          const body = card.querySelector(".section-body");
          const toggleBtn = card.querySelector(".section-toggle");
          if (!body || !toggleBtn) return;
    
          toggleBtn.addEventListener("click", () => {
            const currentlyHidden = body.classList.contains("hidden");
            setSectionVisibility(card, currentlyHidden);
          });
        });
    
        const itemToggle = item.querySelector(".item-toggle-all");
        if (itemToggle) {
          const labelAll = itemToggle.querySelector(".toggle-label");
    
          const refreshItemToggleState = () => {
            const innerCards = item.querySelectorAll(".section-card");
            const anyHidden = Array.from(innerCards).some((c) =>
              c
                .querySelector(".section-body")
                .classList.contains("hidden")
            );
            itemToggle.dataset.state = anyHidden ? "hidden" : "shown";
            if (labelAll) labelAll.textContent = anyHidden ? "แสดง" : "ซ่อน";
          };
    
          refreshItemToggleState();
    
          itemToggle.addEventListener("click", () => {
            const makeVisible = itemToggle.dataset.state === "hidden";
            const innerCards = item.querySelectorAll(".section-card");
            innerCards.forEach((card) =>
              setSectionVisibility(card, makeVisible)
            );
            itemToggle.dataset.state = makeVisible ? "shown" : "hidden";
            if (labelAll) labelAll.textContent = makeVisible ? "ซ่อน" : "แสดง";
          });
    
          cards.forEach((card) => {
            const btn = card.querySelector(".section-toggle");
            if (!btn) return;
            btn.addEventListener("click", () => {
              setTimeout(refreshItemToggleState, 0);
            });
          });
        }
      }
    
      // -------------------- Reference data (จังหวัด / ลุ่มน้ำ) --------------------
      let REF_DATA = null;
    
      function populateSelectOptions(selectEl, values) {
        if (!selectEl) return;
    
        // ถ้าไม่มีค่า reference เลย ไม่ต้องไปยุ่ง dropdown เดิม
        if (!values || !values.length) return;
    
        const currentSelected = Array.from(selectEl.options)
          .filter((o) => o.selected)
          .map((o) => o.value);
    
        selectEl.innerHTML = "";
        values.forEach((val) => {
          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = val;
          if (currentSelected.includes(val)) opt.selected = true;
          selectEl.appendChild(opt);
        });
      }
    
      function applyReferenceDataToAllItems() {
        if (!REF_DATA) return;
        const basins = REF_DATA.basins || [];
        const provinces = REF_DATA.provinces || [];
    
        document
          .querySelectorAll(".basin-select")
          .forEach((sel) => populateSelectOptions(sel, basins));
        document
          .querySelectorAll(".province-select")
          .forEach((sel) => populateSelectOptions(sel, provinces));
      }
    
      async function initReferenceDropdowns() {
        try {
          const resp = await fetch(APPS_SCRIPT_URL + "?action=getReferenceData");
          const data = await resp.json();
          REF_DATA = data || { basins: [], provinces: [] };
          applyReferenceDataToAllItems();
        } catch (err) {
          console.error("getReferenceData error", err);
          // ถ้า error dropdown จะใช้ option เดิมใน HTML ต่อ
        }
      }
    
      // -------------------- Helper: ช่องอื่น ๆ ที่ควบด้วย checkbox flag --------------------
      function setupOtherWithFlag(item, flagName, inputName) {
        const flag = item.querySelector(`input[name="${flagName}"]`);
        const input = item.querySelector(`input[name="${inputName}"]`);
        if (!flag || !input) return;
    
        const update = () => {
          const on = flag.checked;
          input.disabled = !on;
          if (!on) {
            input.value = "";
            clearErrorForElement(input);
          }
        };
    
        flag.addEventListener("change", update);
        update();
      }
    
      // -------------------- Tag Stack + Search Filter --------------------
      function setupTagStack(selectEl, tagsContainer, hiddenInput) {
        if (!selectEl || !tagsContainer || !hiddenInput) return;
        let values = [];
    
        function renderTags() {
          tagsContainer.innerHTML = "";
          values.forEach((val) => {
            const span = document.createElement("span");
            span.className = "tag-pill";
            span.dataset.value = val;
            span.innerHTML = `
              <span class="tag-text">${val}</span>
              <span class="tag-remove">×</span>
            `;
            tagsContainer.appendChild(span);
          });
          hiddenInput.value = values.join(", ");
        }
    
        function addValue(val) {
          const v = (val || "").trim();
          if (!v || values.includes(v)) return;
          values.push(v);
          renderTags();
        }
    
        function removeValue(val) {
          const idx = values.indexOf(val);
          if (idx === -1) return;
          values.splice(idx, 1);
          renderTags();
        }
    
        selectEl.addEventListener("dblclick", () => {
          const opt = selectEl.options[selectEl.selectedIndex];
          const text = opt ? opt.textContent.trim() : "";
          if (!text) return;
          if (values.includes(text)) {
            removeValue(text);
          } else {
            addValue(text);
          }
        });
    
        // ลบโดยคลิกที่กากบาท
        tagsContainer.addEventListener("click", (e) => {
          const removeBtn = e.target.closest(".tag-remove");
          if (!removeBtn) return;
          e.preventDefault();
          e.stopPropagation();
          const pill = removeBtn.closest(".tag-pill");
          if (!pill) return;
          const v = pill.dataset.value;
          removeValue(v);
        });
      }
    
      function setupSearchFilter(selectEl, searchInput) {
        if (!selectEl || !searchInput) return;
    
        searchInput.addEventListener("input", () => {
          const term = searchInput.value.trim().toLowerCase();
          const opts = Array.from(selectEl.options);
    
          opts.forEach((opt, idx) => {
            if (idx === 0 && opt.value === "") {
              opt.hidden = false;
              return;
            }
            if (!term) {
              opt.hidden = false;
            } else {
              const match = opt.textContent.toLowerCase().includes(term);
              opt.hidden = !match;
            }
          });
        });
      }
    
      // -------------------- Mark ส่วน A required --------------------
      function markSectionARequired(item) {
        const demName = item.querySelector('input[name="demName[]"]');
        const sourceSelect = item.querySelector(".source-select");
        const yearSelect = item.querySelector(".year-select");
        if (demName) demName.required = true;
        if (sourceSelect) sourceSelect.required = true;
        if (yearSelect) yearSelect.required = true;
      }
    
      // -------------------- Attach handlers ให้ DEM item 1 ใบ --------------------
      function attachOtherFieldHandlers(item) {
        if (!item) return;
    
        attachSectionToggles(item);
        markSectionARequired(item);
    
        // Source
        const sourceSelect = item.querySelector(".source-select");
        const sourceOtherWrapper = item.querySelector(".source-other-wrapper");
        const sourceOtherInput = item.querySelector(".source-other-input");
        if (sourceSelect && sourceOtherWrapper && sourceOtherInput) {
          const updateSource = () => {
            const show = sourceSelect.value === "other";
            sourceOtherWrapper.classList.toggle("hidden", !show);
            sourceOtherInput.disabled = !show;
            if (show) {
              sourceOtherInput.focus();
            } else {
              sourceOtherInput.value = "";
              clearErrorForElement(sourceOtherInput);
            }
          };
          sourceSelect.addEventListener("change", updateSource);
          updateSource();
        }
    
        // Resolution
        const resSelect = item.querySelector(".resolution-select");
        const resOtherWrapper = item.querySelector(".resolution-other-wrapper");
        const resOtherInput = item.querySelector(".resolution-other-input");
        if (resSelect && resOtherWrapper && resOtherInput) {
          const updateRes = () => {
            const show =
              resSelect.value === "lidar_sub1m" ||
              resSelect.value === "other";
            resOtherWrapper.classList.toggle("hidden", !show);
            resOtherInput.disabled = !show;
            if (show) {
              resOtherInput.focus();
            } else {
              resOtherInput.value = "";
              clearErrorForElement(resOtherInput);
            }
          };
          resSelect.addEventListener("change", updateRes);
          updateRes();
        }
    
        // Vertical Datum
        const vDatumSelect = item.querySelector(".vertical-datum-select");
        const vDatumWrapper = item.querySelector(
          ".vertical-datum-other-wrapper"
        );
        const vDatumInput = item.querySelector(
          ".vertical-datum-other-input"
        );
        if (vDatumSelect && vDatumWrapper && vDatumInput) {
          const updateVD = () => {
            const show = vDatumSelect.value === "other";
            vDatumWrapper.classList.toggle("hidden", !show);
            vDatumInput.disabled = !show;
            if (show) {
              vDatumInput.focus();
            } else {
              vDatumInput.value = "";
              clearErrorForElement(vDatumInput);
            }
          };
          vDatumSelect.addEventListener("change", updateVD);
          updateVD();
        }
    
        // Coordinate system
        const coordSelect = item.querySelector(".coord-select");
        const coordWrapper = item.querySelector(".coord-other-wrapper");
        const coordInput = item.querySelector(".coord-other-input");
        if (coordSelect && coordWrapper && coordInput) {
          const updateCoord = () => {
            const show = coordSelect.value === "other";
            coordWrapper.classList.toggle("hidden", !show);
            coordInput.disabled = !show;
            if (show) {
              coordInput.focus();
            } else {
              coordInput.value = "";
              clearErrorForElement(coordInput);
            }
          };
          coordSelect.addEventListener("change", updateCoord);
          updateCoord();
        }
    
        // License
        const licSelect = item.querySelector(".license-select");
        const licWrapper = item.querySelector(".license-other-wrapper");
        const licInput = item.querySelector(".license-other-input");
        if (licSelect && licWrapper && licInput) {
          const updateLic = () => {
            const show = licSelect.value === "other";
            licWrapper.classList.toggle("hidden", !show);
            licInput.disabled = !show;
            if (show) {
              licInput.focus();
            } else {
              licInput.value = "";
              clearErrorForElement(licInput);
            }
          };
          licSelect.addEventListener("change", updateLic);
          updateLic();
        }
    
        // พื้นที่ครอบคลุม (เลือกทีละแบบ)
        const coverageCountryCb = item.querySelector(
          'input[name="coverageCountry[]"]'
        );
        const basinToggle = item.querySelector(".toggle-basin");
        const provinceToggle = item.querySelector(".toggle-province");
        const localToggle = item.querySelector(".toggle-local");
    
        const basinBlock = item.querySelector(".basin-block");
        const provinceBlock = item.querySelector(".province-block");
        const localBlock = item.querySelector(".local-block");
        const localInput = item.querySelector(".local-input");
    
        function updateCoverageGroup() {
          const cbs = [
            coverageCountryCb,
            basinToggle,
            provinceToggle,
            localToggle,
          ].filter(Boolean);
          const selected = cbs.find((cb) => cb.checked);
    
          cbs.forEach((cb) => {
            if (selected && cb !== selected) {
              cb.checked = false;
              cb.disabled = true;
            } else {
              cb.disabled = false;
            }
          });
    
          if (basinBlock && basinToggle) {
            basinBlock.classList.toggle("hidden", !basinToggle.checked);
          }
          if (provinceBlock && provinceToggle) {
            provinceBlock.classList.toggle("hidden", !provinceToggle.checked);
          }
          if (localBlock && localInput && localToggle) {
            const showLocal = localToggle.checked;
            localBlock.classList.toggle("hidden", !showLocal);
            localInput.disabled = !showLocal;
            if (!showLocal) {
              localInput.value = "";
              clearErrorForElement(localInput);
            }
          }
        }
    
        [coverageCountryCb, basinToggle, provinceToggle, localToggle]
          .filter(Boolean)
          .forEach((cb) =>
            cb.addEventListener("change", updateCoverageGroup)
          );
        updateCoverageGroup();
    
        // Tag stack + search
        const basinSelect = item.querySelector(".basin-select");
        const basinTags = item.querySelector(".basin-tags");
        const basinHidden = item.querySelector(".basin-other-input");
        setupTagStack(basinSelect, basinTags, basinHidden);
    
        const provinceSelect = item.querySelector(".province-select");
        const provinceTags = item.querySelector(".province-tags");
        const provinceHidden = item.querySelector(".province-other-input");
        setupTagStack(provinceSelect, provinceTags, provinceHidden);
    
        const basinSearch = item.querySelector(".basin-search");
        setupSearchFilter(basinSelect, basinSearch);
        const provinceSearch = item.querySelector(".province-search");
        setupSearchFilter(provinceSelect, provinceSearch);
    
        // ช่อง "อื่น ๆ" ที่ควบด้วย checkbox flag
        setupOtherWithFlag(
          item,
          "demMethodOtherFlag[]",
          "demMethodOther[]"
        );
        setupOtherWithFlag(item, "formatOtherFlag[]", "formatOther[]");
        setupOtherWithFlag(item, "accessOtherFlag[]", "accessOther[]");
        setupOtherWithFlag(item, "qcOtherFlag[]", "qcOther[]");
        setupOtherWithFlag(item, "useOtherFlag[]", "useOther[]");
    
        // ปุ่มลบ DEM
        const removeBtn = item.querySelector(".btn-remove-dem-item");
        if (removeBtn) {
          removeBtn.addEventListener("click", () => {
            item.remove();
            updateDemIndexes();
          });
        }
      }
    
      // -------------------- Init item แรก --------------------
      const firstItem = demContainer.querySelector(".dem-item");
      attachOtherFieldHandlers(firstItem);
      populateYearSelects();
      updateDemIndexes();
      initReferenceDropdowns();
    
      // -------------------- เพิ่ม DEM item --------------------
      btnAddDemItem.addEventListener("click", () => {
        const first = demContainer.querySelector(".dem-item");
        const clone = first.cloneNode(true);
    
        clone.querySelectorAll("input, textarea, select").forEach((el) => {
          if (el.tagName === "SELECT") {
            el.selectedIndex = 0;
          } else if (
            el.type === "checkbox" ||
            el.type === "radio"
          ) {
            el.checked = false;
            el.disabled = false;
          } else {
            el.value = "";
          }
          if (el.classList.contains("local-input")) {
            el.disabled = true;
          }
        });
    
        clone
          .querySelectorAll(
            ".source-other-wrapper, .resolution-other-wrapper, .vertical-datum-other-wrapper, .coord-other-wrapper, .license-other-wrapper"
          )
          .forEach((wrap) => wrap.classList.add("hidden"));
    
        clone
          .querySelectorAll(
            ".source-other-input, .resolution-other-input, .vertical-datum-other-input, .coord-other-input, .license-other-input"
          )
          .forEach((inp) => {
            inp.disabled = true;
            inp.value = "";
          });
    
        clone
          .querySelectorAll(".basin-block, .province-block")
          .forEach((b) => b.classList.add("hidden"));
    
        const cloneLocalBlock = clone.querySelector(".local-block");
        const cloneLocalInput = clone.querySelector(".local-input");
        const cloneLocalToggle = clone.querySelector(".toggle-local");
        if (cloneLocalBlock && cloneLocalInput && cloneLocalToggle) {
          cloneLocalBlock.classList.add("hidden");
          cloneLocalInput.disabled = true;
          cloneLocalInput.value = "";
          cloneLocalToggle.checked = false;
        }
    
        clone
          .querySelectorAll(".basin-tags, .province-tags")
          .forEach((c) => (c.innerHTML = ""));
        clone
          .querySelectorAll(".basin-other-input, .province-other-input")
          .forEach((inp) => (inp.value = ""));
    
        const basinSearch = clone.querySelector(".basin-search");
        const basinSelect = clone.querySelector(".basin-select");
        if (basinSearch) basinSearch.value = "";
        if (basinSelect) {
          Array.from(basinSelect.options).forEach(
            (opt) => (opt.hidden = false)
          );
        }
        const provinceSearch = clone.querySelector(".province-search");
        const provinceSelect = clone.querySelector(".province-select");
        if (provinceSearch) provinceSearch.value = "";
        if (provinceSelect) {
          Array.from(provinceSelect.options).forEach(
            (opt) => (opt.hidden = false)
          );
        }
    
        demContainer.appendChild(clone);
        attachOtherFieldHandlers(clone);
        populateYearSelects();
        updateDemIndexes();
        applyReferenceDataToAllItems();
      });
    
      // -------------------- Reset Form --------------------
      const resetBtn = document.getElementById("btnResetForm");
      resetBtn.addEventListener("click", (e) => {
        e.preventDefault();
        openConfirmModal(
          "ยืนยันล้างข้อมูล",
          "คุณต้องการล้างค่าทั้งหมดในแบบฟอร์มหรือไม่?",
          () => {
            clearValidationErrors();
            form.reset();
    
            const items = demContainer.querySelectorAll(".dem-item");
            items.forEach((item, idx) => {
              if (idx > 0) item.remove();
            });
    
            const first = demContainer.querySelector(".dem-item");
            if (!first) return;
    
            const basinBlock = first.querySelector(".basin-block");
            const provinceBlock = first.querySelector(".province-block");
            const basinTags = first.querySelector(".basin-tags");
            const provinceTags = first.querySelector(".province-tags");
            const basinHidden = first.querySelector(".basin-other-input");
            const provinceHidden =
              first.querySelector(".province-other-input");
            const localInput = first.querySelector(".local-input");
            const localToggle = first.querySelector(".toggle-local");
            const localBlock = first.querySelector(".local-block");
            const basinSearch = first.querySelector(".basin-search");
            const basinSelect = first.querySelector(".basin-select");
            const provinceSearch = first.querySelector(
              ".province-search"
            );
            const provinceSelect = first.querySelector(
              ".province-select"
            );
    
            if (basinBlock) basinBlock.classList.add("hidden");
            if (provinceBlock) provinceBlock.classList.add("hidden");
            if (basinTags) basinTags.innerHTML = "";
            if (provinceTags) provinceTags.innerHTML = "";
            if (basinHidden) basinHidden.value = "";
            if (provinceHidden) provinceHidden.value = "";
    
            if (localBlock) localBlock.classList.add("hidden");
            if (localInput) {
              localInput.value = "";
              localInput.disabled = true;
            }
            if (localToggle) localToggle.checked = false;
    
            if (basinSearch) basinSearch.value = "";
            if (basinSelect) {
              Array.from(basinSelect.options).forEach(
                (opt) => (opt.hidden = false)
              );
            }
            if (provinceSearch) provinceSearch.value = "";
            if (provinceSelect) {
              Array.from(provinceSelect.options).forEach(
                (opt) => (opt.hidden = false)
              );
            }
    
            attachOtherFieldHandlers(first);
            populateYearSelects();
            updateDemIndexes();
            applyReferenceDataToAllItems();
          }
        );
      });
    
      // -------------------- Collect & Submit --------------------
      function getCheckedValues(container, selector, excludeOther) {
        let vals = Array.from(
          container.querySelectorAll(selector + ":checked")
        ).map((el) => el.value);
        if (excludeOther) {
          vals = vals.filter((v) => {
            if (!v) return false;
            const t = v.toString().toLowerCase().replace(/\s+/g, "");
            return (
              t !== "other" &&
              t !== "อื่นๆ" &&
              t !== "อื่นๆระบุ" &&
              t !== "อื่นๆ(ระบุ)"
            );
          });
        }
        return vals;
      }
    
      function collectFormData() {
        const agency = {
          agencyName: document
            .getElementById("agencyName")
            .value.trim(),
          subUnit: document.getElementById("subUnit").value.trim(),
          contactName: document
            .getElementById("contactName")
            .value.trim(),
          contactPosition: document
            .getElementById("contactPosition")
            .value.trim(),
          contactPhone: document
            .getElementById("contactPhone")
            .value.trim(),
          contactEmail: document
            .getElementById("contactEmail")
            .value.trim(),
        };
    
        const items = [];
        const demItems = demContainer.querySelectorAll(".dem-item");
        demItems.forEach((item) => {
          const itemData = {};
    
          const sourceSelect = item.querySelector(".source-select");
          const sourceOtherInput = item.querySelector(
            ".source-other-input"
          );
    
          itemData.demName =
            item.querySelector('input[name="demName[]"]')?.value.trim() ||
            "";
    
          if (sourceSelect) {
            if (sourceSelect.value === "other") {
              itemData.sourceType =
                (sourceOtherInput?.value || "").trim();
            } else {
              itemData.sourceType = sourceSelect.value || "";
            }
          } else {
            itemData.sourceType = "";
          }
    
          itemData.year =
            item.querySelector(".year-select")?.value || "";
    
          itemData.coverageCountry = getCheckedValues(
            item,
            'input[name="coverageCountry[]"]',
            false
          );
          itemData.coverageBasinTags =
            item.querySelector(".basin-other-input")?.value.trim() ||
            "";
          itemData.coverageProvinceTags =
            item.querySelector(".province-other-input")?.value.trim() ||
            "";
          itemData.coverageLocal =
            item.querySelector('input[name="coverageLocal[]"]')
              ?.value.trim() || "";
    
          const resSelect = item.querySelector(".resolution-select");
          const resOtherInput = item.querySelector(
            ".resolution-other-input"
          );
          if (resSelect) {
            if (
              resSelect.value === "other" ||
              resSelect.value === "lidar_sub1m"
            ) {
              itemData.resolution =
                (resOtherInput?.value || "").trim();
            } else {
              itemData.resolution = resSelect.value || "";
            }
          } else {
            itemData.resolution = "";
          }
    
          itemData.verticalAccuracy =
            item.querySelector('input[name="verticalAccuracy[]"]')
              ?.value || "";
          itemData.horizontalAccuracy =
            item.querySelector('input[name="horizontalAccuracy[]"]')
              ?.value || "";
    
          const vDatumSelect = item.querySelector(
            ".vertical-datum-select"
          );
          const vDatumInput = item.querySelector(
            ".vertical-datum-other-input"
          );
          if (vDatumSelect) {
            if (vDatumSelect.value === "other") {
              itemData.verticalDatum =
                (vDatumInput?.value || "").trim();
            } else {
              itemData.verticalDatum = vDatumSelect.value || "";
            }
          } else {
            itemData.verticalDatum = "";
          }
    
          const coordSelect = item.querySelector(".coord-select");
          const coordInput = item.querySelector(".coord-other-input");
          if (coordSelect) {
            if (coordSelect.value === "other") {
              itemData.coordSys =
                (coordInput?.value || "").trim();
            } else {
              itemData.coordSys = coordSelect.value || "";
            }
          } else {
            itemData.coordSys = "";
          }
    
          itemData.demMethods = getCheckedValues(
            item,
            'input[name^="demMethod"]',
            true
          );
          const demMethodOtherText =
            item.querySelector('input[name="demMethodOther[]"]')
              ?.value.trim() || "";
          if (demMethodOtherText)
            itemData.demMethods.push(demMethodOtherText);
    
          itemData.fileFormats = getCheckedValues(
            item,
            'input[name^="format"]',
            true
          );
          const formatOtherText =
            item.querySelector('input[name="formatOther[]"]')
              ?.value.trim() || "";
          if (formatOtherText)
            itemData.fileFormats.push(formatOtherText);
    
          itemData.fileSize =
            item.querySelector('input[name="fileSize[]"]')?.value ||
            "";
          itemData.fileSizeUnit =
            item.querySelector('select[name="fileSizeUnit[]"]')
              ?.value || "";
    
          const licSelect = item.querySelector(".license-select");
          const licInput = item.querySelector(".license-other-input");
          if (licSelect) {
            if (licSelect.value === "other") {
              itemData.license =
                (licInput?.value || "").trim();
            } else {
              itemData.license = licSelect.value || "";
            }
          } else {
            itemData.license = "";
          }
    
          itemData.accessChannels = getCheckedValues(
            item,
            'input[name^="access"]',
            true
          );
          itemData.accessOther =
            item.querySelector('input[name="accessOther[]"]')
              ?.value.trim() || "";
    
          itemData.qcQa = getCheckedValues(
            item,
            'input[name^="qc"]',
            true
          );
          itemData.qcQaOther =
            item.querySelector('input[name="qcOther[]"]')
              ?.value.trim() || "";
    
          itemData.mainUses = getCheckedValues(
            item,
            'input[name^="use"]',
            true
          );
          itemData.mainUsesOther =
            item.querySelector('input[name="useOther[]"]')
              ?.value.trim() || "";
    
          itemData.remark =
            item.querySelector('textarea[name="remark[]"]')
              ?.value.trim() || "";
    
          items.push(itemData);
        });
    
        return { agency, items };
      }
    
      async function submitToAppsScript(payload) {
        const resp = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
          body: JSON.stringify(payload),
        });
    
        let data = null;
        try {
          data = await resp.json();
        } catch (e) {
          data = null;
        }
        return data || { success: resp.ok };
      }
    
      // -------------------- Validate Form --------------------
      function validateForm() {
        clearValidationErrors();
        let valid = true;
    
        // หน่วยงาน
        requiredAgencyIds.forEach((id) => {
          const el = document.getElementById(id);
          if (el && !el.value.trim()) {
            showError(el, "กรุณากรอกข้อมูลให้ครบ");
            valid = false;
          }
        });
    
        // email format (หยาบ ๆ)
        const emailEl = document.getElementById("contactEmail");
        if (emailEl && emailEl.value.trim()) {
          const re = /\S+@\S+\.\S+/;
          if (!re.test(emailEl.value.trim())) {
            showError(emailEl, "รูปแบบอีเมลไม่ถูกต้อง");
            valid = false;
          }
        }
    
        // โทรศัพท์ check อีกครั้ง
        const phoneEl = document.getElementById("contactPhone");
        if (phoneEl && phoneEl.value.trim()) {
          const digits = phoneEl.value.replace(/\D/g, "");
          if (digits.length !== 9 && digits.length !== 10) {
            showError(
              phoneEl,
              "กรุณากรอกหมายเลขโทรศัพท์ 9 หรือ 10 หลัก (ไม่ต้องใส่ขีด)"
            );
            valid = false;
          }
        }
    
        // DEM items
        const demItems = demContainer.querySelectorAll(".dem-item");
        demItems.forEach((item) => {
          const demName = item.querySelector('input[name="demName[]"]');
          if (demName && !demName.value.trim()) {
            showError(demName, "กรุณากรอกชื่อชุดข้อมูล DEM");
            valid = false;
          }
    
          const sourceSelect = item.querySelector(".source-select");
          if (sourceSelect) {
            if (!sourceSelect.value) {
              showError(sourceSelect, "กรุณาเลือกแหล่งที่มาของข้อมูล");
              valid = false;
            } else if (sourceSelect.value === "other") {
              const sourceOther = item.querySelector(
                ".source-other-input"
              );
              if (!sourceOther.value.trim()) {
                showError(
                  sourceOther,
                  "กรุณาระบุแหล่งที่มาของข้อมูล"
                );
                valid = false;
              }
            }
          }
    
          const yearSelect = item.querySelector(".year-select");
          if (yearSelect && !yearSelect.value.trim()) {
            showError(yearSelect, "กรุณาเลือกปีจัดทำ");
            valid = false;
          }
    
          const resSelect = item.querySelector(".resolution-select");
          if (resSelect) {
            if (!resSelect.value) {
              showError(
                resSelect,
                "กรุณาเลือกความละเอียดเชิงพื้นที่"
              );
              valid = false;
            } else if (
              resSelect.value === "other" ||
              resSelect.value === "lidar_sub1m"
            ) {
              const resOther = item.querySelector(
                ".resolution-other-input"
              );
              if (!resOther.value.trim()) {
                showError(
                  resOther,
                  "กรุณาระบุความละเอียดเชิงพื้นที่"
                );
                valid = false;
              }
            }
          }
    
          const vSelect = item.querySelector(".vertical-datum-select");
          if (vSelect) {
            if (!vSelect.value) {
              showError(vSelect, "กรุณาเลือก Vertical Datum");
              valid = false;
            } else if (vSelect.value === "other") {
              const vOther = item.querySelector(
                ".vertical-datum-other-input"
              );
              if (!vOther.value.trim()) {
                showError(
                  vOther,
                  "กรุณาระบุ Vertical Datum"
                );
                valid = false;
              }
            }
          }
    
          const coordSelect = item.querySelector(".coord-select");
          if (coordSelect) {
            if (!coordSelect.value) {
              showError(coordSelect, "กรุณาเลือกระบบพิกัด");
              valid = false;
            } else if (coordSelect.value === "other") {
              const cOther = item.querySelector(".coord-other-input");
              if (!cOther.value.trim()) {
                showError(cOther, "กรุณาระบุระบบพิกัด");
                valid = false;
              }
            }
          }
    
          const licSelect = item.querySelector(".license-select");
          if (licSelect) {
            if (!licSelect.value) {
              showError(
                licSelect,
                "กรุณาเลือกลิขสิทธิ์ / เงื่อนไขการใช้ข้อมูล"
              );
              valid = false;
            } else if (licSelect.value === "other") {
              const lOther = item.querySelector(".license-other-input");
              if (!lOther.value.trim()) {
                showError(lOther, "กรุณาระบุลิขสิทธิ์");
                valid = false;
              }
            }
          }
        });
    
        return valid;
      }
    
      // -------------------- Handle Submit --------------------
      form.addEventListener("submit", (e) => {
        e.preventDefault();
    
        if (!validateForm()) {
          // ถ้ามี error จะไม่ส่งต่อ
          return;
        }
    
        openConfirmModal(
          "ยืนยันการส่งแบบฟอร์ม",
          "โปรดตรวจสอบข้อมูลให้ถูกต้อง ก่อนยืนยันการส่งแบบฟอร์ม",
          async () => {
            const payload = collectFormData();
            try {
              const res = await submitToAppsScript(payload);
              if (res && res.success) {
                openSuccessModal();
              } else {
                alert("บันทึกข้อมูลไม่สำเร็จ กรุณาลองใหม่อีกครั้ง");
              }
    
              form.reset();
              clearValidationErrors();
    
              const items = demContainer.querySelectorAll(".dem-item");
              items.forEach((item, idx) => {
                if (idx > 0) item.remove();
              });
    
              const first = demContainer.querySelector(".dem-item");
              if (first) attachOtherFieldHandlers(first);
    
              populateYearSelects();
              updateDemIndexes();
              applyReferenceDataToAllItems();
            } catch (err) {
              console.error("submitDemSurvey error", err);
              alert(
                "เกิดข้อผิดพลาดในการบันทึกข้อมูล โปรดลองอีกครั้ง"
              );
            }
          }
        );
      });
    </script>

    
  </body>
</html>
